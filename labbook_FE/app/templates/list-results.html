{% extends "skeleton.html" %}

{% block head %}
{{ super() }}
    {% block title %}
    <title>Saisie de résultats</title>
    {% endblock %}
    <link href="{{ session['server_ext'] }}/css/result.css?0" media="screen" rel="stylesheet" type="text/css">
{% endblock %}

{% block tag_body %}<body class="yui3-skin-sam yui-skin-sam {{ session['user_role']|safe }}">{% endblock %}
{% block content %}        
<div id="content">
    <div class="inner">
        <div id="main">
            <h2 class="page-title saisie-resultat">
                <span>Saisie de résultats</span>
            </h2>
            <div id="results">
                <form id="form_main" class="vzn-form form-horizontal row" enctype="application/x-www-form-urlencoded" method="post" action="{{ session['server_ext'] }}/sigl/result/index/index">
                    <fieldset id="filter-group" class="group group-1">
                        <legend>Filtre</legend>
                        <div class="row">
                            <div id="filter" class="col-xs-12">
                                <div class="form-group">
                                    <div class="statictext control-label"><span>Date de la demande du</span></div>
                                    <div class="field date-fields form-inline">
                                        <input id="f_date_beg" class="voo_date voo_date_field_1 form-control" type="date" maxlength="10" size="10" value="" placeholder="" style="color: #888;">
                                    </div>
                                    <div class="statictext control-label"><span>au</span></div>
                                    <div class="field date-fields form-inline">
                                        <input id="f_date_end" class="voo_date voo_date_field_1 form-control" type="date" maxlength="10" size="10" value="" placeholder="" style="color: #888;">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <div class="statictext control-label">Type</div>
                                    <div class="field">
                                        <select name="type_ana" id="f_type_ana" class="form-control">
                                            <option value="0" selected="selected"></option>
                                            {% for type_ana in ihm['type_ana'] %}
                                            <option value="{{ type_ana['id_data'] }}">{{ type_ana['label'] }}</option>
                                            {% endfor %}
                                        </select>       
                                    </div>
                                </div>

                                <div class="form-group">
                                    <div class="field">
                                        <input id="f_emer_ana" type="checkbox" name="urgent" value="4">
                                    </div>
                                    <div class="statictext control-label">
                                        <label for="f_emer_ana">Afficher uniquement les analyses prioritaires</label>
                                    </div>
                                    <div class="field">
                                        <input id="f_valid_res" type="checkbox" name="valid" value="1">
                                    </div>
                                    <div class="statictext control-label">
                                        <label for="f_valid_res">Masquer les résultats déjà validés</label>
                                    </div>
                                </div>
                                <div class="form-group button">
                                    <input class="btn btn-primary" type="submit" name="update-filter" onclick="filter_result();return false;" value="Appliquer le filtre">
                                </div>
                            </div>
                        </div>
                    </fieldset>
                </form>

                <div id="analyses">
                    <div id="no_result" class="error">Aucune analyse</div>
                    <div id="list_result"></div>
                    <div id="list_result_test"></div>

                    <div id="dialog_upd_paiement" class="modal fade" role="dialog" tabindex="-1" aria-labelledby="myModalLabel" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">x</button>
                                    <h3 id="myModalLabel"><?php echo gettext( 'TR_ANC_ADHERENT_14' );?></h3>
                                </div>
                                <div class="modal-body">
                                    <div class="row">
                                        <div class="col-xs-4">
                                            <label><?php echo gettext( "TR_ANC_ADHERENT_15" );?></label>
                                            <input class="form-control" type="date" name="date_paiement" id="date_paiement" value="<?php echo date("Y-m-d");?>" />
                                        </div>
                                        <div class="col-xs-4 col-xs-offset-1">
                                            <label><?php echo gettext( "TR_ANC_ADHERENT_16" );?></label>
                                            <select name="mode_paiement" id="mode_paiement">
                                                <option value="C" selected="selected"><?php echo gettext( "TR_ANC_ADHERENT_17" );?></option>
                                                <option value="Q"><?php echo gettext( "TR_ANC_ADHERENT_18" );?></option>
                                                <option value="V"><?php echo gettext( "TR_ANC_ADHERENT_19" );?></option>
                                            </select>
                                        </div>
                                        <div class="col-xs-12" style="margin-top:10px;">
                                            <label><?php echo gettext( 'TR_ANC_ADHERENT_20' );?> :</label>
                                            <textarea style="width:100%;" rows="3" id="comm_paiement" name="comm_paiement">
                                            </textarea>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button class="btn btn-primary" onclick="postpaiement(); $('#dialog_confirm_paiement').modal('hide');"><?php echo gettext( 'TXT_YES' );?></button>
                                    <button class="btn" data-dismiss="modal" aria-hidden="true"><?php echo gettext( 'TXT_NO' );?></button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="modal fade" id="dial_history" role="dialog" tabindex="-1">
                        <div class="yui-module yui-overlay yui-panel" style="width: auto;">
                            <div class="hd">Historique</div>
                            <a class="container-close" href="#">Close</a>
                            <div class="bd">  
                                <div class="yui-dt listing">
                                    <table>
                                        <tbody>
                                            <tr class="yui-dt-odd">
                                                <td class="icon-container status">
                                                    <span class="icon status-n">N</span>
                                                </td>
                                                <td class="date">25/01/2020</td>
                                                <td>
                                                    <ul>
                                                        <li>Création du dossier (2020000003).</li>
                                                        <li>Analyse demandée : Acide fusidique</li>
                                                        <li>Date de prescription : 27/01/2020.</li>
                                                    </ul>
                                                </td>
                                            </tr>
                                            <tr class="yui-dt-even">
                                                <td class="icon-container status">
                                                    <span class="icon status-a">A</span>
                                                </td>
                                                <td class="date">25/01/2020</td>
                                                <td>
                                                    <ul>
                                                        <li>Martine BLEJAN</li>
                                                        <li>Validation administrative.</li>
                                                    </ul>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="ft">
                                <span class="button-group">
                                    <span id="yui-gen0" class="yui-button yui-push-button">
                                        <span class="first-child"><button type="button" data-dismiss="modal" aria-hidden="true">Ok</button></span>
                                    </span>
                                </span>
                            </div>
                        </div>
                        <div class="underlay"></div>
                    </div>

                </div>

            </div><!-- ferme results -->

        </div><!-- ferme inner -->
    </div><!-- ferme main -->
</div><!-- ferme le corps -->
{% endblock %}        

{% block add_script %}
<script>
var data_results = {{ args['list_res']|safe }} ;
var id_history   = 0 ;

function filter_result()
{
let date_beg  = $("#f_date_beg").val() ;
let date_end  = $("#f_date_end").val() ;
let type_ana  = $("#f_type_ana").val() ;
let emer_ana  = 0 ;
let valid_res = 0 ;

    if ( $("#f_emer_ana").is(":checked") )
    emer_ana = $("#f_emer_ana").val() ;

    if ( $("#f_valid_res").is(":checked") )
    valid_res = $("#f_valid_res").val() ;

let param = '{ "date_beg":"' + date_beg  + '", ' +
            '"date_end":"' + date_end  + '", ' +
            '"type_ana":' + type_ana  + ', ' +
            '"emer_ana":' + emer_ana  + ', ' +
            '"valid_res":' + valid_res + '}' ;

    $.ajax( {
        type: "POST",
        url: "/services/result/list",
        dataType: 'json',
        contentType: "application/json; charset=utf-8",
        data: param,
        success: function(data)
            {
            console.log("DEBUG success post filter_result data="+JSON.stringify(data));

            data_results = data ;

            display_result( 1 ) ;
            },
        error: function(data)
            {
            console.log("ERROR result list") ;
            alert("Une erreur est survenue lors de la récupération des résultats") ;
            }
    } ) ;

}

function display_histo( id_rec )
{
id_history = id_rec ;

    setTimeout(function()
    {
        $( "#dial_history" ).modal( "show" ) ;
    }, 600) ;
}

function stat( id_stat )
{
let res = '' ;

    if ( id_stat == 182 )
    res = '<span class="icon status-a">A</span>' ;
    else if ( id_stat == 253 )
    res = '<span class="icon status-a">I</span>' ;
    else if ( id_stat == 254 )
    res = '<span class="icon status-t">T</span>' ;
    else if ( id_stat == 255 )
    res = '<span class="icon status-t">I</span>' ;
    else if ( id_stat == 256 )
    res = '<span class="icon status-b">B</span>' ;

return res ;
}

function emer( var_emer )
{
let res = '' ;

    if ( var_emer == 4 )
    res = '<span class="icon urgent">&nbsp;</span>' ;

return res ;
}

function display_result( num_page )
{
    // hide no_result
    if (data_results.length < 1)
    $("#no_result").show() ;
    else
    $("#no_result").hide() ;

gen_ihm_res( data_results ) ;

// Fill result
// $("#list_result_test").text( JSON.stringify(data_results) ) ;
}

function gen_ihm_res( data )
{
let res      = "" ;
let id_dos_p = 0  ;
let id_res_p = 0  ;

    for( i in data )
    {
    let id_dos = data[i].id_dos ;
    let id_res = data[i].id_res ;

        // close the previous form
        if ( id_dos_p != 0 && id_dos != id_dos_p )
        {
        // close the form and table
        res += '</tbody></table></div></fieldset>' +
               '<div class="form-group button tech">' +
                   '<button name="ok" id="save-538" type="button" value="Enregistrer" disabled="disabled" class="btn disabled btn-default">Enregistrer</button>' +
               '</div>' +
               '<input type="hidden" name="date_begin" value="2020-01-19" id="date_begin_538">' +
               '<input type="hidden" name="date_begin_day" value="19" id="date_begin_day_538">' +
               '<input type="hidden" name="date_begin_month" value="01" id="date_begin_month_538">' +
               '<input type="hidden" name="date_begin_year" value="2020" id="date_begin_year_538">' +
               '<input type="hidden" name="date_end" value="2020-02-19" id="date_end_538">' +    
               '<input type="hidden" name="date_end_day" value="19" id="date_end_day_538">' +
               '<input type="hidden" name="date_end_month" value="02" id="date_end_month_538">' +
               '<input type="hidden" name="date_end_year" value="2020" id="date_end_year_538">' +
               '<input type="hidden" name="type" value="0" id="type_538">' +
               '<input type="hidden" name="urgent" value="0" id="urgent_538">' +
               '<input type="hidden" name="valid" value="0" id="valid_538">' +
               '</fieldset>' +
               '</form>' ;
        }

        // new record so new form
        if ( id_dos != id_dos_p )
        {
        id_dos_p = id_dos ;

        let res_name     = data[i].nom ;
        let res_fam      = " [" + data[i].famille + "]" ;
        let num_dos_mois = data[i].num_dos_mois ;
        let num_dos      = Number( (num_dos_mois).substr(6,4) ) ;
        let mois_dos     = (num_dos_mois).substr(4,2) + "/" + (num_dos_mois).substr(0,4) ;

            if (res_fam.length < 4) res_fam = "" ;

        res += '<form id="form-538" enctype="application/x-www-form-urlencoded" method="post" action="" class="vzn-form form-horizontal row">' +
               '<fieldset id="subform-538" class="subform group group-1">' +
               '<legend>' + res_name + res_fam + '</legend>' +
               '<fieldset id="yui_3_10_1_1_1582117454625_106">' +
               '<legend><span class="num-dos">' + num_dos + '</span>&nbsp;' + mois_dos + '</legend>' +
               '<div class="listing table-responsive yui-dt">' +
               '<table class="main">' +
               '<tbody class="yui-dt-data">' ;
        }

        // new analysis so new result line
        if ( id_res != id_res_p )
        {
        id_res_p = id_res ;

        let res_stat  = stat(data[i].stat) ;
        let res_emer  = emer(data[i].urgent)
        let res_label = data[i].libelle ;
        let res_unit  = data[i].unit ;

        res += '<tr class="yui-dt-rec">' +
                   '<td></td>' +
                   '<td class="icon-container"></td>' +
                   '<td class="icon-container">' + res_emer + '</td>' +
                   '<td id="status-9" class="icon-container status">' + res_stat +
                   '</td>' +
                   '<td class="icon-container history">' +
                       '<div id="history-9" class="history-icon" onclick="display_histo(' + id_dos + ');"></div>' +
                       '<div id="history-detail-9" class="hide"></div>' +
                   '</td>' +
                   '<td class="icon-container var-label">' + res_label + '</td>' ;

        let res_answer = data[i].res_answer ;

        console.log("DEBUG res_answer=" + res_answer) ;

        res += '<td class="value"><span id="value-9" class="value">' ;

            if ( Object.keys(res_answer).length > 1)
            {
            res += '<select name="res-9" id="res-9" class="form-control saved">' +
                   '<option value="0"> </option>' ;

                for ( j in res_answer )
                {
                res += '<option value="' + res_answer[j].id_data + '">' + res_answer[j].label + '</option>' ;
                }

            res += '</select>' ;
            }
            else
            {
            res += '<input type="text" name="res-14" id="res-14" value="" class="form-control saved" size="6">' ;
            }

        res += '<input type="hidden" name="type-res-9" value="' + data[i].type_resultat + '" id="type-res-9"></span>&nbsp;' +
               '<span id="unit-9" class="unit show">' + res_unit + '</span></td>' +
               '<td class="optionnal">&nbsp;</td></tr>' ;
        }
    }

    // close last form
    if ( res != "" )
    {
    // close the form and table
    res += '</tbody></table></div></fieldset>' +
           '<div class="form-group button tech">' +
               '<button name="ok" id="save-538" type="button" value="Enregistrer" disabled="disabled" class="btn disabled btn-default">Enregistrer</button>' +
           '</div>' +
           '<input type="hidden" name="date_begin" value="2020-01-19" id="date_begin_538">' +
           '<input type="hidden" name="date_begin_day" value="19" id="date_begin_day_538">' +
           '<input type="hidden" name="date_begin_month" value="01" id="date_begin_month_538">' +
           '<input type="hidden" name="date_begin_year" value="2020" id="date_begin_year_538">' +
           '<input type="hidden" name="date_end" value="2020-02-19" id="date_end_538">' +    
           '<input type="hidden" name="date_end_day" value="19" id="date_end_day_538">' +
           '<input type="hidden" name="date_end_month" value="02" id="date_end_month_538">' +
           '<input type="hidden" name="date_end_year" value="2020" id="date_end_year_538">' +
           '<input type="hidden" name="type" value="0" id="type_538">' +
           '<input type="hidden" name="urgent" value="0" id="urgent_538">' +
           '<input type="hidden" name="valid" value="0" id="valid_538">' +
           '</fieldset>' +
           '</form>' ;
    }

    $("#list_result").html( res ) ;
}

$( document ).ready( function()
{
$("#f_date_beg").val( "{{ now|date_now }}" ) ;
$("#f_date_end").val( "{{ now|date_now }}" ) ;

display_result( 1 ) ;
} ) ;
</script>
{% endblock %}

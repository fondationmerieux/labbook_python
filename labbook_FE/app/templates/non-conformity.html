{% extends "skeleton.html" %}

{% block head %}
{{ super() }}
    <title>{{ _("Non-conformité") }}</title>
    <link href="{{ url_for('static', filename='vendor/css/bootstrap-datepicker3.min.css') }}" rel="stylesheet" />
    <link href="{{ url_for('static', filename='vendor/css/select2.min.css') }}" rel="stylesheet" />
    <script type="text/javascript" src="{{ url_for('static', filename='vendor/js/select2.min.js') }}"></script>
{% endblock %}

{% block content %}
<div id="content">
    <div class="inner">
        <div id="main" style="opacity: 1;">
            <h2 class="page-title page-title-{{ session['user_role']|safe }}"><span>{{ _("Non-conformité") }}</span></h2>
            <form autocomplete="off">
                <div class="form-group row mt-3">
                    <label for="name" class="col-form-label col-3 text-right mt-2">{{ _("Nom de la non-conformité") }}</label>
                    <div>					
                        <input type="text" name="name" id="name" value="{{ args['details']['name'] }}" class="form-control">			
                    </div>
                </div> 
                <div class="form-group row">
                    <label for="search_reporter" class="col-form-label col-3 text-right mr-1">{{ _("Rapporteur") }}</label>
                    <div>
                        <select id="search_reporter" style="width:400px"></select>
                        <span class="ml-2">{{ args['details']['reporter'] }}</span>
                    </div>
                </div>

                <fieldset class="border p-2">
                    <legend class="w-auto legend-lbk">{{ _("DECLARATION DE LA NON-CONFORMITE") }}</legend>
                    <div class="form-group row">
                        <label for="report_date" class="col-form-label col-3 text-right mt-2">{{ _("Date") }}</label>
                        <div>					
                            <input id="report_date" name="report_date" class="form-control" type="date" maxlength="10" size="10" value="{{ args['details']['report_date'] }}" style="color: #888;">
                        </div>
                    </div>

                    <!-- PREANA category -->
                    <span class="offset-2 font-info">{{ _("Catégorie de la non-conformité") }}</span>

                    <div class="form-group row">
                        <label for="cat_preana" class="col-form-label col-3 text-right ml-1 mr-2">{{ _("Pré analytique") }}</label>
                        <div class="form-inline">
                            <input id="cat_preana" name="cat_preana" type="checkbox" value="4" onchange="cat_change(this);">
                        </div>
                    </div>

                    <!-- preana SUB category -->
                    <div class="form-group row mt-n4 sub_preana d-none">
                        <label for="sub_preana_cat1" class="col-form-label col-4 text-right ml-1 mr-2">{{ _("Prescription") }}</label>
                        <div class="form-inline">
                            <input id="sub_preana_cat1" name="sub_preana_cat1" type="checkbox" value="4">
                        </div>
                    </div>
                    <div class="form-group row mt-n4 sub_preana d-none">
                        <label for="sub_preana_cat2" class="col-form-label col-4 text-right ml-1 mr-2">{{ _("Oubli ou examen erroné") }}</label>
                        <div class="form-inline">
                            <input id="sub_preana_cat2" name="sub_preana_cat2" type="checkbox" value="4">
                        </div>
                    </div>
                    <div class="form-group row mt-n4 sub_preana d-none">
                        <label for="sub_preana_cat3" class="col-form-label col-4 text-right ml-1 mr-2">{{ _("Dossier du patient / identité patient") }}</label>
                        <div class="form-inline">
                            <input id="sub_preana_cat3" name="sub_preana_cat3" type="checkbox" value="4">
                        </div>
                    </div>
                    <div class="form-group row mt-n4 sub_preana d-none">
                        <label for="sub_preana_cat4" class="col-form-label col-4 text-right ml-1 mr-2">{{ _("Prélèvement") }}</label>
                        <div class="form-inline">
                            <input id="sub_preana_cat4" name="sub_preana_cat4" type="checkbox" value="4" onchange="sub_cat_change(this);">
                        </div>
                    </div>

                    <!-- SUB category from sub_preana_cat4 -->
                    <div class="form-group row mt-n4 sub_sub_preana_cat4 d-none">
                        <label for="sub1_sub_preana_cat4" class="col-form-label col-5 text-right ml-1 mr-2">{{ _("Heure de prélèvement") }}</label>
                        <div class="form-inline">
                            <input id="sub1_sub_preana_cat4" name="sub1_sub_preana_cat4" type="checkbox" value="4">
                        </div>
                    </div>
                    <div class="form-group row mt-n4 sub_sub_preana_cat4 d-none">
                        <label for="sub2_preana_cat4" class="col-form-label col-5 text-right ml-1 mr-2">{{ _("Volume de prélèvement") }}</label>
                        <div class="form-inline">
                            <input id="sub2_sub_preana_cat4" name="sub2_sub_preana_cat4" type="checkbox" value="4">
                        </div>
                    </div>
                    <div class="form-group row mt-n4 sub_sub_preana_cat4 d-none">
                        <label for="sub3_sub_preana_cat4" class="col-form-label col-5 text-right ml-1 mr-2">{{ _("Identification du prélèvement") }}</label>
                        <div class="form-inline">
                            <input id="sub3_sub_preana_cat4" name="sub3_sub_preana_cat4" type="checkbox" value="4">
                        </div>
                    </div>

                    <div class="form-group row mt-n4 sub_preana d-none">
                        <label for="sub_preana_cat5" class="col-form-label col-4 text-right ml-1 mr-2">{{ _("Renseignement clinique") }}</label>
                        <div class="form-inline">
                            <input id="sub_preana_cat5" name="sub_preana_cat5" type="checkbox" value="4">
                        </div>
                    </div>
                    <div class="form-group row mt-n4 sub_preana d-none">
                        <label for="sub_preana_cat6" class="col-form-label col-4 text-right ml-1 mr-2">{{ _("Transport de l'échantillon") }}</label>
                        <div class="form-inline">
                            <input id="sub_preana_cat6" name="sub_preana_cat6" type="checkbox" value="4">
                        </div>
                    </div>
                    <div class="form-group row mt-n4 sub_preana d-none">
                        <label for="sub_preana_cat7" class="col-form-label col-4 text-right ml-1 mr-2">{{ _("Respect procédures") }}</label>
                        <div class="form-inline">
                            <input id="sub_preana_cat7" name="sub_preana_cat7" type="checkbox" value="4">
                        </div>
                    </div>
                    <div class="form-group row mt-n4 sub_preana d-none">
                        <label for="sub_preana_cat8" class="col-form-label col-4 text-right ml-1 mr-2">{{ _("Urgence") }}</label>
                        <div class="form-inline">
                            <input id="sub_preana_cat8" name="sub_preana_ca8" type="checkbox" value="4">
                        </div>
                    </div>
                    <div class="form-group row mt-n4 sub_preana d-none">
                        <label for="sub_preana_cat9" class="col-form-label col-4 text-right ml-1 mr-2">{{ _("Traçabilité") }}</label>
                        <div class="form-inline">
                            <input id="sub_preana_cat9" name="sub_preana_cat9" type="checkbox" value="4">
                        </div>
                    </div>
                    <div class="form-group row mt-n4 sub_preana d-none">
                        <label for="sub_preana_cat10" class="col-form-label col-4 text-right ml-1 mr-2">{{ _("Autres") }}</label>
                        <div class="form-inline">
                            <textarea id="sub_preana_cat10" name="sub_preana_cat10" rows="4" cols="50" class="form-control"></textarea>
                        </div>
                    </div>

                    <!-- ANALY category -->
                    <div class="form-group row mt-n4">
                        <label for="cat_analy" class="col-form-label col-3 text-right ml-1 mr-2">{{ _("Analytique") }}</label>
                        <div class="form-inline">
                            <input id="cat_analy" name="cat_analy" type="checkbox" value="4" onchange="cat_change(this);">
                        </div>
                    </div>

                    <!-- ANALY SUB category -->
                    <div class="form-group row mt-n4 sub_analy d-none">
                        <label for="sub_analy_cat1" class="col-form-label col-4 text-right ml-1 mr-2">{{ _("Conservation échantillon avant analyse") }}</label>
                        <div class="form-inline">
                            <input id="sub_analy_cat1" name="sub_analy_cat1" type="checkbox" value="4">
                        </div>
                    </div>
                    <div class="form-group row mt-n4 sub_analy d-none">
                        <label for="sub_analy_cat2" class="col-form-label col-4 text-right ml-1 mr-2">{{ _("Urgence") }}</label>
                        <div class="form-inline">
                            <input id="sub_analy_cat2" name="sub_analy_cat2" type="checkbox" value="4">
                        </div>
                    </div>
                    <div class="form-group row mt-n4 sub_analy d-none">
                        <label for="sub_analy_cat3" class="col-form-label col-4 text-right ml-1 mr-2">{{ _("Centrifugation") }}</label>
                        <div class="form-inline">
                            <input id="sub_analy_cat3" name="sub_analy_cat3" type="checkbox" value="4">
                        </div>
                    </div>
                    <div class="form-group row mt-n4 sub_analy d-none">
                        <label for="sub_analy_cat4" class="col-form-label col-4 text-right ml-1 mr-2">{{ _("Aliquotage") }}</label>
                        <div class="form-inline">
                            <input id="sub_analy_cat4" name="sub_analy_cat4" type="checkbox" value="4">
                        </div>
                    </div>
                    <div class="form-group row mt-n4 sub_analy d-none">
                        <label for="sub_analy_cat5" class="col-form-label col-4 text-right ml-1 mr-2">{{ _("Contrôle qualité interne") }}</label>
                        <div class="form-inline">
                            <input id="sub_analy_cat5" name="sub_analy_cat5" type="checkbox" value="4">
                        </div>
                    </div>
                    <div class="form-group row mt-n4 sub_analy d-none">
                        <label for="sub_analy_cat6" class="col-form-label col-4 text-right ml-1 mr-2">{{ _("Contrôle qualité externe") }}</label>
                        <div class="form-inline">
                            <input id="sub_analy_cat6" name="sub_analy_cat6" type="checkbox" value="4">
                        </div>
                    </div>
                    <div class="form-group row mt-n4 sub_analy d-none">
                        <label for="sub_analy_cat7" class="col-form-label col-4 text-right ml-1 mr-2">{{ _("Traçabilité") }}</label>
                        <div class="form-inline">
                            <input id="sub_analy_cat7" name="sub_analy_cat7" type="checkbox" value="4">
                        </div>
                    </div>
                    <div class="form-group row mt-n4 sub_analy d-none">
                        <label for="sub_analy_cat8" class="col-form-label col-4 text-right ml-1 mr-2">{{ _("Respect procédures") }}</label>
                        <div class="form-inline">
                            <input id="sub_analy_cat8" name="sub_analy_cat8" type="checkbox" value="4">
                        </div>
                    </div>
                    <div class="form-group row mt-n4 sub_analy d-none">
                        <label for="sub_analy_cat9" class="col-form-label col-4 text-right ml-1 mr-2">{{ _("Absence de résultats/Résultats aberrants") }}</label>
                        <div class="form-inline">
                            <input id="sub_analy_cat9" name="sub_analy_cat9" type="checkbox" value="4">
                        </div>
                    </div>
                    <div class="form-group row mt-n4 sub_analy d-none">
                        <label for="sub_analy_cat10" class="col-form-label col-4 text-right ml-1 mr-2">{{ _("Critère de repasse non respecté") }}</label>
                        <div class="form-inline">
                            <input id="sub_analy_cat10" name="sub_analy_cat10" type="checkbox" value="4">
                        </div>
                    </div>
                    <div class="form-group row mt-n4 sub_analy d-none">
                        <label for="sub_analy_cat11" class="col-form-label col-4 text-right ml-1 mr-2">{{ _("Autres") }}</label>
                        <div class="form-inline">
                            <textarea id="sub_analy_cat11" name="sub_analy_cat11" rows="4" cols="50" class="form-control"></textarea>
                        </div>
                    </div>

                    <!-- POSTANA category -->
                    <div class="form-group row mt-n4">
                        <label for="cat_postana" class="col-form-label col-3 text-right ml-1 mr-2">{{ _("Post analytique") }}</label>
                        <div class="form-inline">
                            <input id="cat_postana" name="cat_postana" type="checkbox" value="4" onchange="cat_change(this);">
                        </div>
                    </div>

                    <!-- POSTANA SUB category -->
                    <div class="form-group row mt-n4 sub_postana d-none">
                        <label for="sub_postana_cat1" class="col-form-label col-4 text-right ml-1 mr-2">{{ _("Dossier non validé") }}</label>
                        <div class="form-inline">
                            <input id="sub_postana_cat1" name="sub_postana_cat1" type="checkbox" value="4">
                        </div>
                    </div>
                    <div class="form-group row mt-n4 sub_postana d-none">
                        <label for="sub_postana_cat2" class="col-form-label col-4 text-right ml-1 mr-2">{{ _("Validation partielle non / mal réalisée") }}</label>
                        <div class="form-inline">
                            <input id="sub_postana_cat2" name="sub_postana_cat2" type="checkbox" value="4">
                        </div>
                    </div>
                    <div class="form-group row mt-n4 sub_postana d-none">
                        <label for="sub_postana_cat3" class="col-form-label col-4 text-right ml-1 mr-2">{{ _("Résultat erroné / aberrant") }}</label>
                        <div class="form-inline">
                            <input id="sub_postana_cat3" name="sub_postana_cat3" type="checkbox" value="4">
                        </div>
                    </div>
                    <div class="form-group row mt-n4 sub_postana d-none">
                        <label for="sub_postana_cat4" class="col-form-label col-4 text-right ml-1 mr-2">{{ _("Absence de résultat") }}</label>
                        <div class="form-inline">
                            <input id="sub_postana_cat4" name="sub_postana_cat4" type="checkbox" value="4">
                        </div>
                    </div>
                    <div class="form-group row mt-n4 sub_postana d-none">
                        <label for="sub_postana_cat5" class="col-form-label col-4 text-right ml-1 mr-2">{{ _("Erreur de saisie") }}</label>
                        <div class="form-inline">
                            <input id="sub_postana_cat5" name="sub_postana_cat5" type="checkbox" value="4">
                        </div>
                    </div>
                    <div class="form-group row mt-n4 sub_postana d-none">
                        <label for="sub_postana_cat6" class="col-form-label col-4 text-right ml-1 mr-2">{{ _("Interprétation des résultats") }}</label>
                        <div class="form-inline">
                            <input id="sub_postana_cat6" name="sub_postana_cat6" type="checkbox" value="4">
                        </div>
                    </div>
                    <div class="form-group row mt-n4 sub_postana d-none">
                        <label for="sub_postana_cat7" class="col-form-label col-4 text-right ml-1 mr-2">{{ _("Prestation de conseil") }}</label>
                        <div class="form-inline">
                            <input id="sub_postana_cat7" name="sub_postana_cat7" type="checkbox" value="4">
                        </div>
                    </div>
                    <div class="form-group row mt-n4 sub_postana d-none">
                        <label for="sub_postana_cat8" class="col-form-label col-4 text-right ml-1 mr-2">{{ _("Sérothèque/conservation échantillon après analyse") }}</label>
                        <div class="form-inline">
                            <input id="sub_postana_cat8" name="sub_postana_cat8" type="checkbox" value="4">
                        </div>
                    </div>
                    <div class="form-group row mt-n4 sub_postana d-none">
                        <label for="sub_postana_cat9" class="col-form-label col-4 text-right ml-1 mr-2">{{ _("Respect procédures") }}</label>
                        <div class="form-inline">
                            <input id="sub_postana_cat9" name="sub_postana_cat9" type="checkbox" value="4">
                        </div>
                    </div>
                    <div class="form-group row mt-n4 sub_postana d-none">
                        <label for="sub_postana_cat10" class="col-form-label col-4 text-right ml-1 mr-2">{{ _("Autres") }}</label>
                        <div class="form-inline">
                            <textarea id="sub_postana_cat10" name="sub_postana_cat10" rows="4" cols="50" class="form-control"></textarea>
                        </div>
                    </div>
                    
                    <!-- RES category -->
                    <div class="form-group row mt-n4">
                        <label for="cat_res" class="col-form-label col-3 text-right ml-1 mr-2">{{ _("Transmission des résultats") }}</label>
                        <div class="form-inline">
                            <input id="cat_res" name="cat_res" type="checkbox" value="4" onchange="cat_change(this);">
                        </div>
                    </div>

                    <!-- RES SUB category -->
                    <div class="form-group row mt-n4 sub_res d-none">
                        <label for="sub_res_cat1" class="col-form-label col-4 text-right ml-1 mr-2">{{ _("Défaut/Absence de transmission patient") }}</label>
                        <div class="form-inline">
                            <input id="sub_res_cat1" name="sub_res_cat1" type="checkbox" value="4">
                        </div>
                    </div>
                    <div class="form-group row mt-n4 sub_res d-none">
                        <label for="sub_res_cat2" class="col-form-label col-4 text-right ml-1 mr-2">{{ _("Défaut/Absence de transmission Prescripteur/Correspondant") }}</label>
                        <div class="form-inline">
                            <input id="sub_res_cat2" name="sub_res_cat2" type="checkbox" value="4">
                        </div>
                    </div>
                    <div class="form-group row mt-n4 sub_res d-none">
                        <label for="sub_res_cat3" class="col-form-label col-4 text-right ml-1 mr-2">{{ _("Accès aux résultats") }}</label>
                        <div class="form-inline">
                            <input id="sub_res_cat3" name="sub_res_cat3" type="checkbox" value="4">
                        </div>
                    </div>
                    <div class="form-group row mt-n4 sub_res d-none">
                        <label for="sub_res_cat4" class="col-form-label col-4 text-right ml-1 mr-2">{{ _("Date de rendu erronée") }}</label>
                        <div class="form-inline">
                            <input id="sub_res_cat4" name="sub_res_cat4" type="checkbox" value="4">
                        </div>
                    </div>
                    <div class="form-group row mt-n4 sub_res d-none">
                        <label for="sub_res_cat5" class="col-form-label col-4 text-right ml-1 mr-2">{{ _("Délai de transmission non respecté") }}</label>
                        <div class="form-inline">
                            <input id="sub_res_cat5" name="sub_res_cat5" type="checkbox" value="4">
                        </div>
                    </div>
                    <div class="form-group row mt-n4 sub_res d-none">
                        <label for="sub_res_cat6" class="col-form-label col-4 text-right ml-1 mr-2">{{ _("Non respect de la procédure de rendu des résultats") }}</label>
                        <div class="form-inline">
                            <input id="sub_res_cat6" name="sub_res_cat6" type="checkbox" value="4">
                        </div>
                    </div>
                    <div class="form-group row mt-n4 sub_res d-none">
                        <label for="sub_res_cat7" class="col-form-label col-4 text-right ml-1 mr-2">{{ _("Autres") }}</label>
                        <div class="form-inline">
                            <textarea id="sub_res_cat7" name="sub_res_cat7" rows="4" cols="50" class="form-control"></textarea>
                        </div>
                    </div>

                    <!--HR category  -->
                    <div class="form-group row mt-n4">
                        <label for="cat_hr" class="col-form-label col-3 text-right ml-1 mr-2">{{ _("Ressources humaines") }}</label>
                        <div class="form-inline">
                            <input id="cat_hr" name="cat_hr" type="checkbox" value="4" onchange="cat_change(this);">
                        </div>
                    </div>

                    <!-- HR SUB category -->
                    <div class="form-group row mt-n4 sub_hr d-none">
                        <label for="sub_hr_cat1" class="col-form-label col-4 text-right ml-1 mr-2">{{ _("Non respect procédure") }}</label>
                        <div class="form-inline">
                            <input id="sub_hr_cat1" name="sub_hr_cat1" type="checkbox" value="4">
                        </div>
                    </div>
                    <div class="form-group row mt-n4 sub_hr d-none">
                        <label for="sub_hr_cat2" class="col-form-label col-4 text-right ml-1 mr-2">{{ _("Absence") }}</label>
                        <div class="form-inline">
                            <input id="sub_hr_cat2" name="sub_hr_cat2" type="checkbox" value="4">
                        </div>
                    </div>
                    <div class="form-group row mt-n4 sub_hr d-none">
                        <label for="sub_hr_cat3" class="col-form-label col-4 text-right ml-1 mr-2">{{ _("Habilitation/maintien des compétences") }}</label>
                        <div class="form-inline">
                            <input id="sub_hr_cat3" name="sub_hr_cat3" type="checkbox" value="4">
                        </div>
                    </div>
                    <div class="form-group row mt-n4 sub_hr d-none">
                        <label for="sub_hr_cat4" class="col-form-label col-4 text-right ml-1 mr-2">{{ _("Accident exposition au sang / Hygiène et sécurité") }}</label>
                        <div class="form-inline">
                            <input id="sub_hr_cat4" name="sub_hr_cat4" type="checkbox" value="4">
                        </div>
                    </div>
                    <div class="form-group row mt-n4 sub_hr d-none">
                        <label for="sub_hr_cat5" class="col-form-label col-4 text-right ml-1 mr-2">{{ _("Autres") }}</label>
                        <div class="form-inline">
                            <textarea id="sub_hr_cat5" name="sub_hr_cat5" rows="4" cols="50" class="form-control"></textarea>
                        </div>
                    </div>

                    <!-- EQUIPMENT category -->
                    <div class="form-group row mt-n4">
                        <label for="cat_eqp" class="col-form-label col-3 text-right ml-1 mr-2">{{ _("Equipements") }}</label>
                        <div class="form-inline">
                            <input id="cat_eqp" name="cat_eqp" type="checkbox" value="4" onchange="cat_change(this);">
                        </div>
                    </div>

                    <!-- EQUIPMENT SUB category -->
                    <div class="form-group row mt-n4 sub_eqp d-none">
                        <label for="sub_eqp_cat1" class="col-form-label col-4 text-right ml-1 mr-2">{{ _("Etalonnage, Certification, Calibrage") }}</label>
                        <div class="form-inline">
                            <input id="sub_eqp_cat1" name="sub_eqp_cat1" type="checkbox" value="4">
                        </div>
                    </div>
                    <div class="form-group row mt-n4 sub_eqp d-none">
                        <label for="sub_eqp_cat2" class="col-form-label col-4 text-right ml-1 mr-2">{{ _("Calibration automate") }}</label>
                        <div class="form-inline">
                            <input id="sub_eqp_cat2" name="sub_eqp_cat2" type="checkbox" value="4">
                        </div>
                    </div>
                    <div class="form-group row mt-n4 sub_eqp d-none">
                        <label for="sub_eqp_cat3" class="col-form-label col-4 text-right ml-1 mr-2">{{ _("Alarme") }}</label>
                        <div class="form-inline">
                            <input id="sub_eqp_cat3" name="sub_eqp_cat3" type="checkbox" value="4">
                        </div>
                    </div>
                    <div class="form-group row mt-n4 sub_eqp d-none">
                        <label for="sub_eqp_cat4" class="col-form-label col-4 text-right ml-1 mr-2">{{ _("Panne d'un équipement") }}</label>
                        <div class="form-inline">
                            <input id="sub_eqp_cat4" name="sub_eqp_cat4" type="checkbox" value="4">
                        </div>
                    </div>
                    <div class="form-group row mt-n4 sub_eqp d-none">
                        <label for="sub_eqp_cat5" class="col-form-label col-4 text-right ml-1 mr-2">{{ _("Respect procédure") }}</label>
                        <div class="form-inline">
                            <input id="sub_eqp_cat5" name="sub_eqp_cat5" type="checkbox" value="4">
                        </div>
                    </div>
                    <div class="form-group row mt-n4 sub_eqp d-none">
                        <label for="sub_eqp_cat6" class="col-form-label col-4 text-right ml-1 mr-2">{{ _("Autres") }}</label>
                        <div class="form-inline">
                            <textarea id="sub_eqp_cat6" name="sub_eqp_cat6" rows="4" cols="50" class="form-control"></textarea>
                        </div>
                    </div>
                    <!-- TODO add search equipment -->

                    <!-- CONSUMABLE category -->
                    <div class="form-group row mt-n4">
                        <label for="cat_consu" class="col-form-label col-3 text-right ml-1 mr-2">{{ _("Réactifs et consommables") }}</label>
                        <div class="form-inline">
                            <input id="cat_consu" name="cat_consu" type="checkbox" value="4" onchange="cat_change(this);">
                        </div>
                    </div>

                    <!-- CONSUMABLE SUB category -->
                    <div class="form-group row mt-n4 sub_consu d-none">
                        <label for="sub_consu_cat1" class="col-form-label col-4 text-right ml-1 mr-2">{{ _("Réception de réactifs et/ou consommables ne correspondant pas à la commande") }}</label>
                        <div class="form-inline">
                            <input id="sub_consu_cat1" name="sub_consu_cat1" type="checkbox" value="4">
                        </div>
                    </div>
                    <div class="form-group row mt-n4 sub_consu d-none">
                        <label for="sub_consu_cat2" class="col-form-label col-4 text-right ml-1 mr-2">{{ _("Délai livraison") }}</label>
                        <div class="form-inline">
                            <input id="sub_consu_cat2" name="sub_consu_cat2" type="checkbox" value="4">
                        </div>
                    </div>
                    <div class="form-group row mt-n4 sub_consu d-none">
                        <label for="sub_consu_cat3" class="col-form-label col-4 text-right ml-1 mr-2">{{ _("Réactifs périmés") }}</label>
                        <div class="form-inline">
                            <input id="sub_consu_cat3" name="sub_consu_cat3" type="checkbox" value="4">
                        </div>
                    </div>
                    <div class="form-group row mt-n4 sub_consu d-none">
                        <label for="sub_consu_cat4" class="col-form-label col-4 text-right ml-1 mr-2">{{ _("Rupture de stock (cf nom du fournisseur)") }}</label>
                        <div class="form-inline">
                            <input id="sub_consu_cat4" name="sub_consu_cat4" type="checkbox" value="4">
                        </div>
                    </div>
                    <div class="form-group row mt-n4 sub_consu d-none">
                        <label for="sub_consu_cat5" class="col-form-label col-4 text-right ml-1 mr-2">{{ _("Déstockage produits non conforme") }}</label>
                        <div class="form-inline">
                            <input id="sub_consu_cat5" name="sub_consu_cat5" type="checkbox" value="4">
                        </div>
                    </div>
                    <div class="form-group row mt-n4 sub_consu d-none">
                        <label for="sub_consu_cat6" class="col-form-label col-4 text-right ml-1 mr-2">{{ _("Autres") }}</label>
                        <div class="form-inline">
                            <textarea id="sub_consu_cat6" name="sub_consu_cat6" rows="4" cols="50" class="form-control"></textarea>
                        </div>
                    </div>
                    <!-- TODO add search supplier -->

                    <!-- LOCAL category -->
                    <div class="form-group row mt-n4">
                        <label for="cat_local" class="col-form-label col-3 text-right ml-1 mr-2">{{ _("Locaux et environnement") }}</label>
                        <div class="form-inline">
                            <input id="cat_local" name="cat_local" type="checkbox" value="4" onchange="cat_change(this);">
                        </div>
                    </div>

                    <!-- LOCAL SUB category -->
                    <div class="form-group row mt-n4 sub_local d-none">
                        <label for="sub_local_cat1" class="col-form-label col-4 text-right ml-1 mr-2">{{ _("Nettoyage du laboratoire") }}</label>
                        <div class="form-inline">
                            <input id="sub_local_cat1" name="sub_local_cat1" type="checkbox" value="4">
                        </div>
                    </div>
                    <div class="form-group row mt-n4 sub_local d-none">
                        <label for="sub_local_cat2" class="col-form-label col-4 text-right ml-1 mr-2">{{ _("Entretien du batiment") }}</label>
                        <div class="form-inline">
                            <input id="sub_local_cat2" name="sub_local_cat2" type="checkbox" value="4">
                        </div>
                    </div>
                    <div class="form-group row mt-n4 sub_local d-none">
                        <label for="sub_local_cat3" class="col-form-label col-4 text-right ml-1 mr-2">{{ _("Coupure d'électricité") }}</label>
                        <div class="form-inline">
                            <input id="sub_local_cat3" name="sub_local_cat3" type="checkbox" value="4">
                        </div>
                    </div>
                    <div class="form-group row mt-n4 sub_local d-none">
                        <label for="sub_local_cat4" class="col-form-label col-4 text-right ml-1 mr-2">{{ _("Coupure d'eau") }}</label>
                        <div class="form-inline">
                            <input id="sub_local_cat4" name="sub_local_cat4" type="checkbox" value="4">
                        </div>
                    </div>
                    <div class="form-group row mt-n4 sub_local d-none">
                        <label for="sub_local_cat5" class="col-form-label col-4 text-right ml-1 mr-2">{{ _("Gestion des déchets") }}</label>
                        <div class="form-inline">
                            <input id="sub_local_cat5" name="sub_local_cat5" type="checkbox" value="4">
                        </div>
                    </div>
                    <div class="form-group row mt-n4 sub_local d-none">
                        <label for="sub_local_cat6" class="col-form-label col-4 text-right ml-1 mr-2">{{ _("Autres") }}</label>
                        <div class="form-inline">
                            <textarea id="sub_local_cat6" name="sub_local_cat6" rows="4" cols="50" class="form-control"></textarea>
                        </div>
                    </div>

                    <!-- SI category -->
                    <div class="form-group row mt-n4">
                        <label for="cat_si" class="col-form-label col-3 text-right ml-1 mr-2">{{ _("Systèmes informatiques") }}</label>
                        <div class="form-inline">
                            <input id="cat_si" name="cat_si" type="checkbox" value="4" onchange="cat_change(this);">
                        </div>
                    </div>

                    <!-- SI SUB category -->
                    <div class="form-group row mt-n4 sub_si d-none">
                        <label for="sub_si_cat1" class="col-form-label col-5 text-right ml-1 mr-2">{{ _("Abscence de connexion") }}</label>
                        <div class="form-inline">
                            <input id="sub_si_cat1" name="sub_si_cat1" type="checkbox" value="4">
                        </div>
                    </div>
                    <div class="form-group row mt-n4 sub_si d-none">
                        <label for="sub_si_cat2" class="col-form-label col-5 text-right ml-1 mr-2">{{ _("Errer de paramétrage") }}</label>
                        <div class="form-inline">
                            <input id="sub_si_cat2" name="sub_si_cat2" type="checkbox" value="4">
                        </div>
                    </div>
                    <div class="form-group row mt-n4 sub_si d-none">
                        <label for="sub_si_cat3" class="col-form-label col-5 text-right ml-1 mr-2">{{ _("Panne réseau") }}</label>
                        <div class="form-inline">
                            <input id="sub_si_cat3" name="sub_si_cat3" type="checkbox" value="4">
                        </div>
                    </div>
                    <div class="form-group row mt-n4 sub_si d-none">
                        <label for="sub_si_cat4" class="col-form-label col-5 text-right ml-1 mr-2">{{ _("Panne système d'information") }}</label>
                        <div class="form-inline">
                            <input id="sub_si_cat4" name="sub_si_cat4" type="checkbox" value="4">
                        </div>
                    </div>
                    <div class="form-group row mt-n4 sub_si d-none">
                        <label for="sub_si_cat5" class="col-form-label col-5 text-right ml-1 mr-2">{{ _("Pannes matériel informatique") }}</label>
                        <div class="form-inline">
                            <input id="sub_si_cat5" name="sub_si_cat5" type="checkbox" value="4">
                        </div>
                    </div>
                    <div class="form-group row mt-n4 sub_si d-none">
                        <label for="sub_si_cat6" class="col-form-label col-5 text-right ml-1 mr-2">{{ _("Autres") }}</label>
                        <div class="form-inline">
                            <textarea id="sub_si_cat6" name="sub_si_cat6" rows="4" cols="50" class="form-control"></textarea>
                        </div>
                    </div>

                    <!-- CONTRACT category -->
                    <div class="form-group row mt-n4">
                        <label for="cat_contract" class="col-form-label col-3 text-right ml-1 mr-2">{{ _("Sous-traitance") }}</label>
                        <div class="form-inline">
                            <input id="cat_contract" name="cat_contract" type="checkbox" value="4" onchange="cat_change(this);">
                        </div>
                    </div>

                    <!-- CONTRACT SUB category -->
                    <div class="form-group row mt-n4 sub_contract d-none">
                        <label for="sub_contract_cat1" class="col-form-label col-5 text-right ml-1 mr-2">{{ _("Délai de rendu non respecté") }}</label>
                        <div class="form-inline">
                            <input id="sub_contract_cat1" name="sub_contract_cat1" type="checkbox" value="4">
                        </div>
                    </div>
                    <div class="form-group row mt-n4 sub_contract d-none">
                        <label for="sub_contract_cat2" class="col-form-label col-5 text-right ml-1 mr-2">{{ _("Erreur / oubli examen") }}</label>
                        <div class="form-inline">
                            <input id="sub_contract_cat2" name="sub_contract_cat2" type="checkbox" value="4">
                        </div>
                    </div>
                    <div class="form-group row mt-n4 sub_contract d-none">
                        <label for="sub_contract_cat3" class="col-form-label col-5 text-right ml-1 mr-2">{{ _("Mauvaise conservation lors du transport") }}</label>
                        <div class="form-inline">
                            <input id="sub_contract_cat3" name="sub_contract_cat3" type="checkbox" value="4">
                        </div>
                    </div>
                    <div class="form-group row mt-n4 sub_contract d-none">
                        <label for="sub_contract_cat4" class="col-form-label col-5 text-right ml-1 mr-2">{{ _("Problème de facturation") }}</label>
                        <div class="form-inline">
                            <input id="sub_contract_cat4" name="sub_contract_cat4" type="checkbox" value="4">
                        </div>
                    </div>
                    <div class="form-group row mt-n4 sub_contract d-none">
                        <label for="sub_contract_cat5" class="col-form-label col-5 text-right ml-1 mr-2">{{ _("Autres") }}</label>
                        <div class="form-inline">
                            <textarea id="sub_contract_cat5" name="sub_contract_cat5" rows="4" cols="50" class="form-control"></textarea>
                        </div>
                    </div>

                    <!-- CLIENT category -->
                    <div class="form-group row">
                        <label for="cat_client" class="col-form-label col-3 text-right ml-1 mr-2">{{ _("Réclamations clients") }}</label>
                        <div class="form-inline">
                            <textarea id="cat_client" name="cat_client" rows="4" cols="50" class="form-control"></textarea>
                        </div>
                    </div>

                    <!-- OTHER category -->
                    <div class="form-group row">
                        <label for="cat_other" class="col-form-label col-3 text-right ml-1 mr-2">{{ _("Autre") }}</label>
                        <div class="form-inline">
                            <textarea id="cat_other" name="cat_other" rows="4" cols="50" class="form-control"></textarea>
                        </div>
                    </div>
                    
                    <!-- ABOUT PATIENT RECORD ? -->
                    <div class="form-group row">
                        <label class="col-form-label col-3 text-right mt-2">{{ _("Est ce que cette non-conformité concerne un dossier patient ?") }}</label>
                        <label class="col-form-label text-right mt-2 mr-3">
                            <input type="radio" class="mr-1" name="about_pat_rec" value="4">{{ _("Oui") }}</input>
                        </label>
                        <label class="col-form-label text-right mt-2 mr-3">
                            <input type="radio" class="mr-1" name="about_pat_rec" value="5" checked="checked">{{ _("Non") }}</input>
                        </label>
                    </div>

                    <!-- DESCRIPTION -->
                    <div class="form-group row mt-3">
                        <label for="description" class="col-form-label col-3 text-right mt-2">{{ _("Description de la non-conformité") }}</label>
                        <div>					
                            <textarea id="description" name="description" rows="4" cols="50" class="form-control">{{ args['details']['description'] }}</textarea>
                        </div>
                    </div>

                    <!-- PATIENT IMPACT -->
                    <div class="form-group row">
                        <label class="col-form-label col-3 text-right mt-2">{{ _("Impact sur le patient") }}</label>
                        <label class="col-form-label text-right mt-2 mr-3">
                            <input type="radio" class="mr-1" name="impact_pat" value="4">{{ _("Faible") }}</input>
                        </label>
                        <label class="col-form-label text-right mt-2 mr-3">
                            <input type="radio" class="mr-1" name="impact_pat" value="5">{{ _("Important") }}</input>
                        </label>
                        <label class="col-form-label text-right mt-2 mr-3">
                            <input type="radio" class="mr-1" name="impact_pat" value="6">{{ _("Grave") }}</input>
                        </label>
                        <label class="col-form-label text-right mt-2 mr-3">
                            <input type="radio" class="mr-1" name="impact_pat" value="7" checked="checked">{{ _("Aucun") }}</input>
                        </label>
                    </div>

                    <!-- USER IMPACT -->
                    <div class="form-group row">
                        <label class="col-form-label col-3 text-right mt-2">{{ _("Impact sur le personnel/visiteur") }}</label>
                        <label class="col-form-label text-right mt-2 mr-3">
                            <input type="radio" class="mr-1" name="impact_user" value="4">{{ _("Faible") }}</input>
                        </label>
                        <label class="col-form-label text-right mt-2 mr-3">
                            <input type="radio" class="mr-1" name="impact_user" value="5">{{ _("Important") }}</input>
                        </label>
                        <label class="col-form-label text-right mt-2 mr-3">
                            <input type="radio" class="mr-1" name="impact_user" value="6">{{ _("Grave") }}</input>
                        </label>
                        <label class="col-form-label text-right mt-2 mr-3">
                            <input type="radio" class="mr-1" name="impact_user" value="7" checked="checked">{{ _("Aucun") }}</input>
                        </label>
                    </div>
                </fieldset>

                <fieldset class="border p-2">
                    <legend class="w-auto legend-lbk">{{ _("SUIVI DE LA NON-CONFORMITE") }}</legend>
                    <div class="form-group row">
                        <label for="search_followed" class="col-form-label col-3 text-right mr-1">{{ _("Qui") }}</label>
                        <div>
                            <select id="search_followed" style="width:400px"></select>
                            <span class="ml-2">{{ args['details']['followed'] }}</span>
                        </div>
                    </div>
                    <div class="form-group row">
                        <label for="flwd_what" class="col-form-label col-3 text-right mt-2">{{ _("Quoi") }}</label>
                        <div>					
                            <textarea id="flwd_what" name="flwd_what" rows="4" cols="50" class="form-control">{{ args['details']['flwd_what'] }}</textarea>
                        </div>
                    </div>
                    <div class="form-group row">
                        <label for="flwd_when" class="col-form-label col-3 text-right mt-2">{{ _("Quand") }}</label>
                        <div>					
                            <input id="flwd_when" name="flwd_when" class="form-control" type="date" maxlength="10" size="10" value="{{ args['details']['flwd_when'] }}" style="color: #888;">
                        </div>
                    </div>

                    <!-- IMPLEMENTATION OF ACTION  -->
                    <div class="form-group row">
                        <label class="col-form-label col-3 text-right mt-2">{{ _("Mise en place d’une action correctrice") }}</label>
                        <label class="col-form-label text-right mt-2 mr-3">
                            <input type="radio" class="mr-1" name="impl_action" value="4">{{ _("Oui") }}</input>
                        </label>
                        <label class="col-form-label text-right mt-2 mr-3">
                            <input type="radio" class="mr-1" name="impl_action" value="5" checked="checked">{{ _("Non") }}</input>
                        </label>
                    </div>

                    <div class="form-group row">
                        <label for="flwd_descr_action" class="col-form-label col-3 text-right mt-2">{{ _("Description de l'action correctrice") }}</label>
                        <div>					
                            <textarea id="flwd_descr_action" name="flwd_descr_action" rows="4" cols="50" class="form-control">{{ args['details']['flwd_descr_action'] }}</textarea>
                        </div>
                    </div>
                    <div class="form-group row">
                        <label for="flwd_action_date" class="col-form-label col-3 text-right mt-2">{{ _("Date de réalisation de l'action correctrice") }}</label>
                        <div>					
                            <input id="flwd_action_date" name="flwd_action_date" class="form-control" type="date" maxlength="10" size="10" value="{{ args['details']['flwd_action_date'] }}" style="color: #888;">
                        </div>
                    </div>
                    <div class="form-group row">
                        <label for="search_incharge" class="col-form-label col-3 text-right mr-1">{{ _("Responsable de l'action") }}</label>
                        <div>
                            <select id="search_incharge" style="width:400px"></select>
                            <span class="ml-2">{{ args['details']['incharge'] }}</span>
                        </div>
                    </div>
                </fieldset>

                <fieldset class="border p-2">
                    <legend class="w-auto legend-lbk">{{ _("CLOTURE DE LA NON-CONFORMITE") }}</legend>
                    <div class="form-group row">
                        <label for="close_comment" class="col-form-label col-3 text-right mt-2">{{ _("Commentaire") }}</label>
                        <div>					
                            <textarea id="close_comment" name="close_comment" rows="4" cols="50" class="form-control">{{ args['details']['close_comment'] }}</textarea>
                        </div>
                    </div>
                    <div class="form-group row">
                        <label for="search_validate" class="col-form-label col-3 text-right mr-1">{{ _("Validé par") }}</label>
                        <div>
                            <select id="search_validate" style="width:400px"></select>
                            <span class="ml-2">{{ args['details']['close_vld'] }}</span>
                        </div>
                    </div>
                    <div class="form-group row">
                        <label for="close_date" class="col-form-label col-3 text-right mt-2">{{ _("Date de clotûre") }}</label>
                        <div>					
                            <input id="close_date" name="close_date" class="form-control" type="date" maxlength="10" size="10" value="{{ args['details']['close_date'] }}" style="color: #888;">
                        </div>
                    </div>
                </fieldset>
            </form>
            
            <div class="my-2 clearfix">
                <div class="float-left" style="margin-left:0px;">
                    <input type="button" onclick="cancel();" id="btn_cancel" value="{{ _("Annuler") }}" class="btn btn-{{ session['user_role']|safe }}">
                </div>
                <div class="float-right">
                    <input type="button" onclick="save_item();" id="btn_save" value="{{ _("Enregistrer") }}" class="btn btn-{{ session['user_role']|safe }} ml-2">
                </div>
            </div>
        </div>
    </div>
</div><!-- close content -->
{% endblock %}

{% block add_script %}
<script>
$("#search_reporter").select2(
{
    placeholder: "{{ _("Cliquer pour commencer une recherche") }}",
    tags: false,
    multiple: false,
    tokenSeparators: [','],
    minimumInputLength: 2,
    ajax: {
        url: "{{ session['server_ext'] }}/services/user/search",
        type: "POST",
        dataType: "json",
        contentType: "application/json; charset=utf-8",
        term: $("#search_reporter").text(),
        data: function (params) {

            return JSON.stringify({
                term: params.term
            });
        },
        processResults: function (data) {
            return {
                results: $.map(data, function (item) {
                    return {
                        text: item.field_value,
                        id: item.id_data
                    }
                })
            };
        }
    }
} ) ;

$("#search_reporter").on("select2:select", function (e) 
{
let id_item = $(e.currentTarget).val();
} ) ;

$("#search_followed").select2(
{
    placeholder: "{{ _("Cliquer pour commencer une recherche") }}",
    tags: false,
    multiple: false,
    tokenSeparators: [','],
    minimumInputLength: 2,
    ajax: {
        url: "{{ session['server_ext'] }}/services/user/search",
        type: "POST",
        dataType: "json",
        contentType: "application/json; charset=utf-8",
        term: $("#search_followed").text(),
        data: function (params) {

            return JSON.stringify({
                term: params.term
            });
        },
        processResults: function (data) {
            return {
                results: $.map(data, function (item) {
                    return {
                        text: item.field_value,
                        id: item.id_data
                    }
                })
            };
        }
    }
} ) ;

$("#search_followed").on("select2:select", function (e) 
{
let id_item = $(e.currentTarget).val();
} ) ;

$("#search_incharge").select2(
{
    placeholder: "{{ _("Cliquer pour commencer une recherche") }}",
    tags: false,
    multiple: false,
    tokenSeparators: [','],
    minimumInputLength: 2,
    ajax: {
        url: "{{ session['server_ext'] }}/services/user/search",
        type: "POST",
        dataType: "json",
        contentType: "application/json; charset=utf-8",
        term: $("#search_incharge").text(),
        data: function (params) {

            return JSON.stringify({
                term: params.term
            });
        },
        processResults: function (data) {
            return {
                results: $.map(data, function (item) {
                    return {
                        text: item.field_value,
                        id: item.id_data
                    }
                })
            };
        }
    }
} ) ;

$("#search_incharge").on("select2:select", function (e) 
{
let id_item = $(e.currentTarget).val();
} ) ;

$("#search_validate").select2(
{
    placeholder: "{{ _("Cliquer pour commencer une recherche") }}",
    tags: false,
    multiple: false,
    tokenSeparators: [','],
    minimumInputLength: 2,
    ajax: {
        url: "{{ session['server_ext'] }}/services/user/search",
        type: "POST",
        dataType: "json",
        contentType: "application/json; charset=utf-8",
        term: $("#search_validate").text(),
        data: function (params) {

            return JSON.stringify({
                term: params.term
            });
        },
        processResults: function (data) {
            return {
                results: $.map(data, function (item) {
                    return {
                        text: item.field_value,
                        id: item.id_data
                    }
                })
            };
        }
    }
} ) ;

$("#search_validate").on("select2:select", function (e) 
{
let id_item = $(e.currentTarget).val();
} ) ;

function cat_change( elem )
{
let id_elem   = $(elem).attr('id') ;

console.log("DEBUG id_elem="+id_elem);

let class_sub_elem = ".sub_" + id_elem.substr(4) ;

    if ( $(elem).is(':checked') )
    {
    $(class_sub_elem).removeClass('d-none') ;   
    }
    else
    {
    $(class_sub_elem).addClass('d-none') ;
    }

}

function sub_cat_change( elem )
{
let id_elem = $(elem).attr('id') ;

console.log("DEBUG id_elem="+id_elem);

let class_sub_elem = ".sub_" + id_elem ;

    if ( $(elem).is(':checked') )
    {
    $(class_sub_elem).removeClass('d-none') ;   
    }
    else
    {
    $(class_sub_elem).addClass('d-none') ;
    }

}

function save_item()
{
var id_owner     = {{ session['user_id_group']|safe }} ;
var id_details   = {{ args['id_det']|safe }} ;
var date_meeting = $("#date_meeting").val()      ;
var type         = $("#type").val()              ;
var reporter     = $("#search_reporter").val()   ;
var followed     = $("#search_followed").val()   ;
var incharge     = $("#search_incharge").val()   ;
var validate     = $("#search_validate").val()   ;
var report       = JSON.stringify( $("#report").val() ) ;

var msg = "" ;

    if (date_meeting == "")
    msg += "{{ _("Veuillez saisir une date de réunion.") }}\n" ;

    if (msg != "")
    {
    alert( msg ) ;
    return false ;
    }

    if (id_details > 0)
    {
        if (reporter < 1)
        reporter = {% if args['details']['reporter_id'] %}{{ args['details']['reporter_id']|safe }}{% else %}0{% endif %} ;

        if (followed < 1)
        followed = {% if args['details']['followed_id'] %}{{ args['details']['followed_id']|safe }}{% else %}0{% endif %} ;

        if (incharge < 1)
        incharge = {% if args['details']['incharge_id'] %}{{ args['details']['incharge_id']|safe }}{% else %}0{% endif %} ;

        if (validate < 1)
        validate = {% if args['details']['validate_id'] %}{{ args['details']['validate_id']|safe }}{% else %}0{% endif %} ;
    }

var param = '{ "id_owner":' + id_owner + ', ' +
              '"id_item":' + id_details + ', ' +
              '"date_meeting":"' + date_meeting + '", ' +
              '"type":' + type + ', ' +
              '"reporter":' + reporter + ', ' +
              '"followed":' + followed + ', ' +
              '"incharge":' + incharge + ', ' +
              '"validate":' + validate + ', ' +
              '"report":' + report + '}' ;  // No quotes with stringify

console.log("DEBUG param=" + JSON.stringify(param)) ;

    $.ajax( {
       type: "POST",
       url: "/services/quality/nonconformity/det/" + id_details,
       dataType: 'json',
       contentType: "application/json; charset=utf-8",
       data: param,
       success: function(data)
           {
           console.log("DEBUG data=" + JSON.stringify(data)) ;

           window.history.back() ;
           },
       error: function(data)
           {
           console.log("ERROR POST item det") ;
           alert("{{ _("Une erreur est survenue lors de l'enregistrement") }}") ;
           }
    } ) ;
}

function cancel()
{
window.history.back() ;
}
</script>
{% endblock %}

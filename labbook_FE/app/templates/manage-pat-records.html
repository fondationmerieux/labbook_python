{% extends "skeleton.html" %}

{% block head %}
{{ super() }}
    <title>{{ _("Gestion dossier patient") }}</title>
    <link href="{{ url_for('static', filename='vendor/css/select2.min.css') }}" rel="stylesheet" />
    <script type="text/javascript" src="{{ url_for('static', filename='vendor/js/select2.min.js') }}"></script>
{% endblock %}

{% block content %}
<div id="content">
    <div class="inner">
        <div id="main" style="opacity: 1;">
            <h2 class="page-title page-title-{{ session['user_role']|safe }}"><span>{{ _("Gestion dossier patient") }}</span></h2>

            <form autocomplete="off">
                <div class="panel-heading row">
                    <h3 class="panel-title">{{ _("Fusionner 2 dossiers patients") }}</h3>
                </div>
                <div class="panel-patient row mt-3">
                    <div class="col-10">
                        <div class="form-group row">
                            <label for="search_patient1" class="col-form-label col-4 text-right optional">{{ _("Nom, prénom ou code du patient") }}</label>
                            <div>
                                <select id="search_patient1" style="width:450px"></select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="panel-patient row mt-3">
                    <div class="col-10">
                        <div class="form-group row">
                            <label for="search_patient2" class="col-form-label col-4 text-right optional">{{ _("Nom, prénom ou code du patient") }}</label>
                            <div>
                                <select id="search_patient2" style="width:450px"></select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <div class="float-left" style="margin-left:0px;">
                            <input type="button" onclick="return_home();" id="exit" class="btn btn-{{ session['user_role']|safe }}" value="{{ _("Quitter") }}">
                        </div>
                        <div class="float-right mr-2">
                            <input type="button" onclick="save_request();" id="save" class="btn btn-{{ session['user_role']|safe }}" value="{{ _("Fusionner") }}" disabled>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div><!-- ferme le corps -->
{% endblock %}

{% block add_script %}
<script>
var id_pat1 = 0 ;
var id_pat2 = 0 ;

$("#search_patient1").select2(
{
    placeholder: "{{ _("Cliquer pour commencer une recherche") }}",
    tags: false,
    multiple: false,
    tokenSeparators: [','],
    minimumInputLength: 2,
    ajax: {
        url: "{{ session['server_ext'] }}/services/patient/search",
        type: "POST",
        dataType: "json",
        contentType: "application/json; charset=utf-8",
        term: $("#search_patient1").text(),
        data: function (params) {
            return JSON.stringify({
                term: params.term
            });
        },
        processResults: function (data) {
            return {
                // data need id key if not no focus selection displayed
                results: data
            } ;
        }
    },
    templateResult: formatRepo
} ) ;

$("#search_patient2").select2(
{
    placeholder: "{{ _("Cliquer pour commencer une recherche") }}",
    tags: false,
    multiple: false,
    tokenSeparators: [','],
    minimumInputLength: 2,
    ajax: {
        url: "{{ session['server_ext'] }}/services/patient/search",
        type: "POST",
        dataType: "json",
        contentType: "application/json; charset=utf-8",
        term: $("#search_patient2").text(),
        data: function (params) {
            return JSON.stringify({
                term: params.term
            });
        },
        processResults: function (data) {
            return {
                // data need id key if not no focus selection displayed
                results: data
            } ;
        }
    },
    templateResult: formatRepo
} ) ;

function formatRepo(repo)
{
    if (repo.loading)
    return repo.text ;

var ident = "" ;

    if (repo.prenom)
    ident += repo.prenom + " " ;

    if (repo.nom)
    ident += repo.nom ;

var code = "" ;

    if (repo.code)
    code += "[" + repo.code + "]" ;

    if (repo.code_patient)
    code += " - code patient : " + repo.code_patient ;

var info = "" ;

    if (repo.ddn)
    info += repo.ddn + " " ; // TODO change format date ?

var display = $(
    "<div class='select2-result-repository clearfix'>" +
        "<div class='select2-result-repository__meta'>" +
            "<div class='select2-result-repository__title'><b>" + ident + " " + code + "</b></div>" +
            "<div class='select2-result-repository__description'>" + info + "</div>" +
        "</div>" +
    "</div>") ;

return display ;
}

$("#search_patient1").on("select2:select", function (e) 
{
id_pat1 = $(e.currentTarget).val();
} ) ;

$("#search_patient2").on("select2:select", function (e) 
{
id_pat2 = $(e.currentTarget).val();
} ) ;

function save_request()
{
console.log("TODO save_request") ;
}

function return_home()
{
window.location.href = "{{ session['server_ext'] }}/sigl/homepage";
}
</script>
{% endblock %}

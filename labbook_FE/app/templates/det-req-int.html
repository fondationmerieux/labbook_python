{% extends "skeleton.html" %}

{% block head %}
{{ super() }}
    <title>{{ _("Details demande d'analyses") }}</title>
    <link href="{{ url_for('static', filename='vendor/bootstrap/css/bootstrap-datepicker3.min.css') }}" rel="stylesheet" />
    <link href="{{ url_for('static', filename='vendor/css/select2.min.css') }}" rel="stylesheet" />
    <script type="text/javascript" src="{{ url_for('static', filename='vendor/js/select2.min.js') }}" nonce="{{ session['nonce'] }}"></script>
{% endblock %}

{% block content %}
<div id="content">
    <div class="inner">
        <div id="main">
            <h2 class="page-title page-title-{{ session['user_role']|safe }}">
                <span>{{ _("Demande d'analyses patient hospitalisé") }}</span>
            </h2>
            <form autocomplete="off">
                {% if entry == 'N' %}
                <div>
                    <span>{{ _("Dossier") }} :</span>
                </div>
                <div id="num-dos-ro">
                    <span class="rec-num" id="num_rec"></span>
                </div>
                {% endif %}
                <div class="form-group d-md-flex align-items-start ms-1 my-3">
                    <label for="rec_num_int" class="form-label text-end mt-2 me-1" style="">{{ _("Numéro de dossier interne au laboratoire") }}</label>
                    <div>
                        <input id="rec_num_int" type="text" value="" maxlength="30" class="form-control form-lbk">
                    </div>
                </div>
                <div class="d-md-flex align-items-start">
                    <div class="col-md-3 panel-heading ms-3">
                        <h3 class="panel-title">{{ _("Identité") }}</h3>
                    </div>
                    <div class="col-md-5 panel-heading ms-3">
                        <h3 class="panel-title">{{ _("Prescription") }}</h3>
                    </div>
                    <div class="col panel-heading ms-3 me-1">
                        <h3 class="panel-title">{{ _("Hospitalisation") }}</h3>
                    </div>
                </div>
                <div class="d-md-flex align-items-start gy-3">
                    <div class="col-md-3 ms-3">
                        <div class="col-md-12 mt-3">
                            {% if args['patient'] and args['patient']['pat_code_lab'] %}
                            <span class="pat-num">{{ args['patient']['pat_code_lab'] }}</span>
                            {% endif %}
                            <span class="pat-num">{% if args['patient'] %}{{ args['patient']['pat_code'] }}{% endif %}</span>
                        </div>
                        <div class="col-md-12 mt-2">
                            {% if args['patient'] and args['patient']['pat_ano'] != 4 %}
                            <span class="font-info">{% if args['patient'] %}{{ args['patient']['pat_firstname'] }} {{ args['patient']['pat_name'] }}{% if args['patient']['pat_maiden'] %} {{ args['patient']['pat_maiden'] }}{% endif %}{% endif %}</span>
                            {% else %}
                            <span class="font-info">{{ _("Patient anonyme") }}.</span>
                            {% endif %}
                        </div>
                        <div class="col-md-12 mt-2">
                            <span>{{ _("Né(e) le") }}&nbsp;</span>
                            <span class="font-info">{% if args['patient'] and args['patient']['pat_birth'] %}{{ args['patient']['pat_birth']|date_format }}{% endif %}</span>
                            <span>&nbsp;-&nbsp;</span>
                            <span class="font-info">{% if args['patient'] %}{{ args['patient']['pat_age'] }}{% endif %}&nbsp;</span>
                            <span class="font-info">{% if args['patient'] %}{% if args['patient']['pat_age_unit'] == 1037 %}{{ _("Années") }}
                                                    {% elif args['patient']['pat_age_unit'] == 1036 %}{{ _("Mois") }}
                                                    {% elif args['patient']['pat_age_unit'] == 1035 %}{{ _("Semaines") }}
                                                    {% elif args['patient']['pat_age_unit'] == 1034 %}{{ _("Jours") }}{% endif %}{% endif %}</span>
                            <span>&nbsp;-&nbsp;</span>
                            <span class="font-info">{% if args['patient'] %}{% if args['patient']['pat_sex'] == 1 %}{{ _("Masculin") }}
                                                    {% elif args['patient']['pat_sex'] == 2 %}{{ _("Féminin") }}
                                                    {% elif args['patient']['pat_sex'] == 3 %}{{ _("Inconnu") }}{% endif %}{% endif %}</span>
                        </div>
                        <div class="col-md-12 mt-1">
                            {% if args['patient'] and args['patient']['pat_address'] %}
                            <span class="font-info">{{ args['patient']['pat_address'] }}</span>
                            {% endif %}
                            {% if args['patient'] and args['patient']['pat_district'] %}
                            <span class="font-info">{{ args['patient']['pat_district'] }}</span>
                            {% endif %}
                            {% if args['patient'] and args['patient']['pat_pbox'] %}
                            <span class="font-info">{{ args['patient']['pat_pbox'] }}</span>
                            {% endif %}
                            {% if args['patient'] and args['patient']['pat_zipcode'] %}
                            <span class="font-info">{{ args['patient']['pat_zipcode'] }}</span>
                            {% endif %}
                            {% if args['patient'] and args['patient']['pat_city'] %}
                            <span class="font-info">{{ args['patient']['pat_city'] }}</span>
                            {% endif %}
                        </div>
                        <div class="col-md-12 mt-1">
                            {% if args['patient'] and args['patient']['pat_phone1'] %}
                            <span class="font-info">{{ args['patient']['pat_phone1'] }}</span>
                            {% endif %}
                            {% if args['patient'] and args['patient']['pat_phone1'] and args['patient']['pat_phone2'] %} / {% endif %}
                            {% if args['patient'] and args['patient']['pat_phone2'] %}
                            <span class="font-info">{{ args['patient']['pat_phone2'] }}</span>
                            {% endif %}
                        </div>
                        {% if entry == 'Y' %}
                        <div class="ms-3 mt-3">
                            <input type="button" onclick="change_pat({% if args['patient'] %}{{ args['patient']['id_data'] }}{% else %}0{% endif %});" class="btn btn-lbk btn-{{ session['user_role']|safe }}" value="{{ _("Modifier le dossier du patient") }}">
                        </div>
                        {% endif %}
                    </div>

                    <div class="col-md-5">
                        <div class="col-md-12 ms-3 mt-1">
                            <div class="form-group d-md-flex">
                                <label for="date_record" class="form-label col-md-6 text-end me-1 mt-2">{{ _("Date de réception du dossier") }} * </label>
                                {% if entry == 'Y' %}
                                <input id="date_record" class="form-control form-lbk" type="datetime-local" value="" placeholder="">
                                {% else %}
                                <span class="font-info">{{ args['record']['rec_date_receipt']|date_format }}</span>
                                {% endif %}
                            </div>
                            <div class="form-group d-md-flex mt-1">
                                <label for="date_prescr" class="form-label col-md-6 text-end me-1 mt-2">{{ _("Date de prescription") }} * </label>
                                {% if entry == 'Y' %}
                                <input id="date_prescr" class="form-control form-lbk" type="date" value="" placeholder="">
                                {% else %}
                                <span class="font-info">{{ args['record']['date_prescription']|date_format }}</span>
                                {% endif %}
                            </div>
                            <div class="form-group d-md-flex align-items-end mt-2">
                                <label class="form-label col-md-5 text-end ms-3 me-1 me-md-3">{{ _("Demande de garde") }}</label>
                                {% if entry == 'Y' %}
                                <label class="form-label text-end me-3">
                                    <input type="radio" name="rec_custody" value="Y" >&nbsp;{{ _("Oui") }}</input>
                                </label>
                                <label class="form-label text-end me-3">
                                    <input type="radio" name="rec_custody" value="N" checked="checked">&nbsp;{{ _("Non") }}</input>
                                </label>
                                {% else %}
                                <span class="font-info">{% if args['record']['rec_custody'] == 'Y' %}{{ _("Oui") }}{% else %}{{ _("Non") }}{% endif %}</span>
                                {% endif %}
                            </div>
                            <div class="form-group d-md-flex align-items-start mt-2">
                                <label for="search_doctor" class="form-label text-end mt-1 me-1">{{ _("Prescripteur") }}</label>
                                {% if entry == 'Y' %}
                                <div class="d-md-flex align-items-start w-100">
                                    <select id="search_doctor" class="form-select form-lbk form-search"></select>
                                    <button type="button" onclick="new_doctor();" id="btn_supplier" class="btn btn-lbk btn-{{ session['user_role']|safe }} ms-1"><i class="bi bi-plus" /></i></button>
                                </div>
                                {% else %}
                                    {% if args['doctor'] %}
                                    <span class="font-info">{{ args['doctor']['nom'] }} {{ args['doctor']['prenom'] }}
                                        {% if args['doctor']['spe_doctor'] %} - {{ args['doctor']['spe_doctor'] }}{% endif %}
                                        {% if args['doctor']['facility'] %} - {{ args['doctor']['facility'] }}{% endif %}
                                    </span>
                                    {% endif %}
                                {% endif %}
                            </div>
                            <div class="form-group d-md-flex align-items-start mt-2">
                                <label class="form-label col-md-3 text-end me-3">{{ _("Colis") }}</label>
                                {% if entry == 'Y' %}
                                <label class="form-label text-end me-3">
                                    <input type="radio" name="parcel" value="4" >&nbsp;{{ _("Oui") }}</input>
                                </label>
                                <label class="form-label text-end me-3">
                                    <input type="radio" name="parcel" value="5" checked="checked">&nbsp;{{ _("Non") }}</input>
                                </label>
                                {% else %}
                                    {% if args['record']['colis'] == 4 %}
                                <span class="font-info">
                                    {{ args['record']['id_colis'] }} {{ args['record']['rec_parcel_date']|date_format }}
                                </span>
                                    {% else %}
                                <span class="font-info">{{ _("Non") }}</span>
                                    {% endif %}
                                {% endif %}
                            </div>
                            <div id="colis-group" class="form-group row" style="display:none;">
                                <div class="form-group d-md-flex align-items-start">
                                    <label class="form-label col-md-5 text-end mt-2" style="">{{ _("Identification du colis") }}</label>
                                    <div>
                                        <input id="parcel_id" type="text" value="" maxlength="30" class="form-control form-lbk ms-1" style="width: 240px;">
                                    </div>
                                </div>
                                <div class="form-group d-md-flex align-items-start mt-1">
                                    <label class="form-label col-md-5 text-end mt-2">{{ _("Date de réception du colis") }} *</label>
                                    <div>
                                        <input id="parcel_date" class="form-control form-lbk ms-1" type="datetime-local" value="" placeholder="" style="color:#888;">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col">
                        <div class="col-12 mt-1">
                            <div class="form-group d-md-flex align-items-start mt-2">
                                <label for="date_hosp" class="form-label col-6 text-end mt-2 me-1">{{ _("Date d'admission") }}</label>
                                {% if entry == 'Y' %}
                                <input id="date_hosp" class="form-control form-lbk" type="date" value="" placeholder="">
                                {% else %}
                                <span class="font-info">{{ args['record']['date_hosp']|date_format }}</span>
                                {% endif %}
                            </div>
                            <div class="form-group d-md-flex align-items-start mt-2">
                                <label for="service_int" class="form-label col-6 text-end mt-2 me-1">{{ _("Service demandeur") }}</label>
                                {% if entry == 'Y' %}
                                    {% if ihm['req_services'] %}
                                    <select id="service_int" class="form-select w-auto">
                                        {% from 'macros.html' import select_req_services %}
                                        {{ select_req_services(ihm['req_services']) }}
                                    </select>
                                    {% else%}
                                    <input id="service_int" type="text" value="" maxlength="50" class="form-control form-lbk" style="">
                                    {% endif %}
                                {% else %}
                                <span class="font-info">{{ args['record']['service_interne'] }}</span>
                                {% endif %}
                            </div>
                            <div class="form-group d-md-flex align-items-start mt-2">
                                <label for="bed_num" class="form-label col-6 text-end mt-2 me-1">{{ _("Numéro de lit") }}</label>
                                {% if entry == 'Y' %}
                                <input id="bed_num" type="number" value="" maxlength="4" class="form-control form-lbk" min="0" max="9999">
                                {% else %}
                                <span class="font-info">{{ args['record']['num_lit'] }}</span>
                                {% endif %}
                            </div>                   
                            <div class="form-group d-md-flex align-items-start mt-2">
                                <label for="rec_hosp_id" class="form-label col-6 text-end mt-2 me-1">{{ _("Identification hôpital") }}</label>
                                {% if entry == 'Y' %}
                                <input id="rec_hosp_num" type="text" value="" class="form-control form-lbk" min="0" max="9999">
                                {% else %}
                                <span class="font-info">{{ args['record']['rec_hosp_num'] }}</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </form>

            <!-- Analyzes -->
            <div class="panel-heading row ms-1">
                <h3 class="panel-title">{{ _("Analyses et actes de prélèvement") }}</h3>
            </div>
            {% if entry == 'Y' %}
            <div class="row ms-3 mt-3">
                <div class="col-md-12">
                    <div class="form-group d-md-flex align-items-start">
                        <label class="form-label col-md-3 text-end me-1 mt-1">{{ _("Rechercher une analyse") }}</label>
                        <div>
                            <select id="search_analysis" class="form-select form-lbk form-search"></select>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
            <div class="row ms-3 mt-3">
                <span class="font-info">{{ _("Analyses") }}</span>
            </div>
            <form class="row justify-content-center mt-3" autocomplete="off">
                <table id="table_analysis" class="table table-striped table-hover col-md-12 table-lbk tablesorter">
                    <thead>
                        <tr>
                            <th hidden>serial</th>
                            {% if entry == 'Y' %}
                            <th class="text-center">{{ _("Action") }}</th>
                            {% endif %}
                            <th class="text-center cursor-act">{{ _("Code") }}</th>
                            <th class="text-center cursor-act">{{ _("Nom") }}</th>
                            <th class="text-center cursor-act">{{ _("Urgent") }}</th>
                            <th class="text-center cursor-act">{{ _("Demandée") }}</th>
                            <th class="text-center cursor-act">{{ _("Cote") }}</th>
                            <th class="text-start cursor-act">{{ _("Prix") }}</th>
                            <th class="text-start cursor-act">{{ _("Sous-traitée") }}</th>
                    </thead>
                    <tbody id="tbody_analysis"></tbody>
                </table>
            </form>

            {% if session['pref_bill'] == '1' %}
            <form autocomplete="off">
                <!-- Billing -->
                <div class="panel-heading row ms-1 mt-2">
                    <h3 class="panel-title">{{ _("Facturation") }}</h3>
                </div>
                <div class="row ms-3">
                    <div class="form-group d-md-flex align-items-start col-md-12 mt-3">
                        <label class="form-label text-end me-1 mt-1">{{ _("Prix total") }}</label>
                        {% if entry == 'Y' %}
                        <input type="number" id="bill_price" name="bill_price" value="" maxlength="16" class="form-control form-lbk bg-readonly col-3" style="width: 160px;" min="0" max="9999999999999" step=".01" readonly="">
                        {% else %}
                        <span class="font-info">{{ args['record']['prix'] }}</span>
                        {% endif %}
                    </div>
                    <div class="form-group d-md-flex align-items-start col-md-12 mt-3">
                        <label class="form-labeltext-end me-1 mt-1">{{ _("Remise sur la facturation") }}</label>
                        {% if entry == 'Y' %}
                        <select id="discount" class="form-select w-auto">
                            {% from 'macros.html' import select_discount_bill %}
                            {{ select_discount_bill(ihm['discount_bill']) }}
                        </select>
                        {% else %}
                        <span class="font-info">{{ args['record']['remise'] }}</span>
                        {% endif %}
                        <label class="form-label text-end ms-3 me-1 mt-1">{{ _("Pourcentage de la remise") }}</label>
                        {% if entry == 'Y' %}
                        <input id="per_discount" type="number" value="" maxlength="8" class="form-control form-lbk" style="width: 96px;" min="0" max="99999" step=".01" onfocus="old_discount=this.value;" onchange="change_per_discount(this);">
                        {% else %}
                        <span class="font-info">{{ args['record']['remise_pourcent'] }}</span>
                        {% endif %}
                    </div>
                    <div class="form-group d-md-flex align-items-start col-md-12 mt-3">
                        <label class="form-label text-end me-1 mt-1">{{ _("Pourcentage assurance maladie / mutuelle") }}</label>
                        {% if entry == 'Y' %}
                        <input id="per_insurance" type="number" value="" maxlength="8" class="form-control form-lbk" style="width: 96px;" min="0" max="99999" step=".01" onfocus="old_insurance=this.value;" onchange="change_per_insurance(this);">
                        {% else %}
                        <span class="font-info">{{ args['record']['assu_pourcent'] }}</span>
                        {% endif %}
                    </div>
                    <div class="form-group d-md-flex align-items-start col-md-12 mt-3">
                        <label class="form-label text-end me-1 mt-1">{{ _("Reste à payer") }}</label>
                        {% if entry == 'Y' %}
                        <input type="number" id="bill_remain" name="bill_remain" value="" maxlength="16" class="form-control form-lbk bg-readonly" style="width: 160px;" min="0" max="9999999999999" step=".01" readonly="">
                        {% else %}
                        <span class="font-info">{{ args['record']['a_payer'] }}</span>
                        {% endif %}
                    </div>
                    <div class="form-group d-md-flex align-items-start col-md-12 mt-3">
                        <label class="form-label text-end me-1 mt-1">{{ _("Numéro de quittance") }}</label>
                        {% if entry == 'Y' %}
                        <input type="text" id="receipt_num" name="receipt_num" value="" maxlength="20" class="form-control form-lbk" style="width: 200px;" null="">
                        {% else %}
                        <span class="font-info">{{ args['record']['num_quittance'] }}</span>
                        {% endif %}
                    </div>
                </div>
            </form>
            {% endif %}

            <!-- Products -->
            <div class="panel-heading row ms-1 mt-2">
                <h3 class="panel-title">{{ _("Produits pathologiques") }}</h3>
            </div>
            {% if entry == 'Y' %}
            <div class="ms-3 mt-3">
                <input type="button" onclick="new_prod();return false;" id="prod_new" class="btn btn-lbk btn-{{ session['user_role']|safe }}" value="{{ _("Ajouter un prélèvement") }}">
            </div>
            {% endif %}
            <form class="row justify-content-center mt-2" autocomplete="off">
                <table id="table_product" class="table table-responsive table-striped table-hover col-md-12 table-lbk">
                    <thead>
                        <tr>
                            <th hidden>serial</th>
                            {% if entry == 'Y' %}
                            <th class="text-center">{{ _("Action") }}</th>
                            {% endif %}
                            <th class="text-left cursor-act">{{ _("Date prélèvement") }}</th>
                            <th class="text-center cursor-act">{{ _("Produit pathologiques") }} *</th>
                            <th class="text-center cursor-act">{{ _("Code") }}</th>
                            <th class="text-center cursor-act">{{ _("Préleveur") }}</th>
                        </tr><tr>
                            <th class="text-center cursor-act">{{ _("Analyse") }}</th>
                            <th class="text-left cursor-act">{{ _("Date réception") }}</th>
                            <th class="text-center cursor-act">{{ _("Statut") }} *</th>
                            <th class="text-center cursor-act" colspan="2">{{ _("Commentaire") }}</th>
                        </tr>
                    </thead>
                    <tbody id="tbody_product"></tbody>
                </table>
            </form>

            <!-- comments -->
            <form autocomplete="off">
                <div class="panel-heading row ms-1 mt-2">
                    <h3 class="panel-title">{{ _("Renseignements / Informations complémentaires") }}</h3>
                </div>
                <div class="row ms-3">
                    <div class="col-md-7 mt-3">
                        {% if entry == 'Y' %}
                        <textarea id="comm" rows="5" cols="80" class="form-control form-lbk"></textarea>
                        {% else %}
                        <span class="font-info">{{ args['record']['rc'] }}</span>
                        {% endif %}
                    </div>
                </div>

                <div class="mb-4 mt-3">
                    <div class="col-md-12 clearfix">
                        <div class="float-start ms-0">
                            <input type="button" onclick="return_home();" id="exit" class="btn btn-lbk btn-{{ session['user_role']|safe }}" value="{{ _("Quitter") }}">
                        </div>
                        <div class="float-end me-2">
                            {% if entry == 'Y' %}
                            <input type="button" onclick="save_requests();" id="save" class="btn btn-lbk btn-{{ session['user_role']|safe }}" value="{{ _("Valider") }}">
                            {% else %}
                            <input type="button" onclick="valid_requests();" id="valid" class="btn btn-lbk btn-{{ session['user_role']|safe }}" value="{{ _("Valider") }}">
                            {% endif %}
                        </div>
                    </div>
                </div>
            </form>

        </div>
    </div>
</div><!-- close content -->
{% endblock %}

{% block add_script %}
<script type="text/javascript" nonce="{{ session['nonce'] }}">
var struct_ana    = {"id_data":0 ,"code":"", "name":"", "emer":0, "req":4, "rate":"", "price":0, "outsourced":"N"} ;
var struct_prod   = {"id_data":0 ,"code":"","type":0, "stat":0, "dateSamp":"", "dateReceipt":"", "sampler":"", "ana":0, "comm":""} ;
var data_analysis = {% if args['data_analysis'] %}{{ args['data_analysis']|safe }}{% else %}[]{% endif %} ;
var data_products = {% if args['data_products'] %}{{ args['data_products']|safe }}{% else %}[]{% endif %} ;
var ind_products  = 0 ;
var old_value     = 0 ;
{% if session['pref_bill'] == '1' %}
var old_discount  = 0 ;
var old_insurance = 0 ;
var bill_price    = 0 ;
var bill_remain   = {% if entry == 'Y' %}0{% else %}{{ args['record']['a_payer'] }}{% endif %} ;
{% endif %}
var act_price     = {% if ihm['act_price']['value'] %}{{ ihm['act_price']['value'] }}{% else %}0{% endif %} ;
var opt_yorn      = {{ ihm['yorn']|safe }} ;
var new_opt_yorn  = [{'value': 'Y', 'label': '{{ _("Oui") }}'}, {'value': 'N', 'label': '{{ _("Non") }}'}] ;
var opt_ana       = [] ;

{% if entry == 'Y' %}
function change_pat( id_pat ) 
{
window.location.href = "{{ session['server_ext'] }}/det-patient/I/" + id_pat ;
}

$("#search_doctor").select2(
{
    placeholder: "{{ _("Cliquer pour commencer une recherche") }}",
    tags: false,
    multiple: false,
    tokenSeparators: [','],
    minimumInputLength: 2,
    ajax: {
        url: "{{ session['server_ext'] }}/services/doctor/search",
        type: "POST",
        dataType: "json",
        contentType: "application/json; charset=utf-8",
        term: $("#search_doctor").text(),
        data: function (params) {

            return JSON.stringify({
                term: params.term
            });
        },
        processResults: function (data) {
            return {
                results: $.map(data, function (item) {
                    return {
                        text: item.field_value,
                        id: item.id_doctor
                    }
                })
            };
        }
    }
} ) ;

$("#search_analysis").select2(
{
    placeholder: "{{ _("Cliquer pour commencer une recherche") }}",
    tags: false,
    multiple: false,
    tokenSeparators: [','],
    minimumInputLength: 2,
    ajax: {
        url: "{{ session['server_ext'] }}/services/analysis/search/A",
        type: "POST",
        dataType: "json",
        contentType: "application/json; charset=utf-8",
        term: $("#search_analysis").text(),
        data: function (params) {
            return JSON.stringify(
            {
                term: params.term,
                link_fam: {{ session['user_link_fam'] or [] }}
            } ) ;
        },
        processResults: function (data) {
            return {
                // data need id key if not no focus selection displayed
                results: data
            } ;
        }
    },
    templateResult: formatRepoAnalysis
} ) ;

function formatRepoAnalysis(repo)
{
    if (repo.loading)
    return repo.text ;

var code = "" ;

    if (repo.code)
    code += "[" + repo.code + "]" ;

var name = "" ;

    if (repo.name)
    name += repo.name ;

var cat = "" ;

    if (repo.label)
    cat += repo.label ;

var display = $(
    "<div class='select2-result-repository clearfix'>" +
        "<div class='select2-result-repository__meta'>" +
            "<div class='select2-result-repository__code'><b>" + code + "</b></div>" +
            "<div class='select2-result-repository__name'>" + name + "</div>" +
            "<div class='select2-result-repository__category'>" + cat + "</div>" +
        "</div>" +
    "</div>") ;

return display ;
}

$("#search_analysis").on("select2:select", function (e) 
{
let id_item    = $(e.currentTarget).val();
let data_exist = false ;

    // check if this analysis is not already used
    if ( !$.isEmptyObject(data_analysis) )
    $.map(data_analysis,function(val,key) { if( val != null && val.id_data == id_item) { data_exist = true; } } ) ;

    if (!data_exist)
    {
        $("#search_analysis").empty() ;

        // ADD det analysis
        $.ajax( {
            type: "GET",
            url: "{{ session['server_ext'] }}/services/analysis/det/" + id_item,
            success: function(data_ana)
                {
                let tmp_struct_ana = JSON.parse(JSON.stringify(struct_ana)) ; // copy structure

                tmp_struct_ana.id_data = data_ana.id_data ;
                tmp_struct_ana.code    = data_ana.code ;
                tmp_struct_ana.name    = data_ana.nom ;
                tmp_struct_ana.rate    = data_ana.cote_unite + data_ana.cote_valeur ;
                tmp_struct_ana.price   = {% if args['billing_hosp']['value'] == "1" %}act_price * data_ana.cote_valeur{% else %}0{% endif %} ;

                data_analysis.push(tmp_struct_ana) ;

                // load new analysis in table
                load_analysis( tmp_struct_ana, 1) ;
                refresh_bill() ;

                // push values in opt_ana array
                opt_ana.push({'id_data': data_ana.id_data, 'label': data_ana.code})

                    // GET det product linked to analysis
                    if ( data_ana.type_prel > 0 )
                    {
                    let id_type_prod = data_ana.type_prel ;

                        // ADD type product
                        $.ajax( {
                            type: "GET",
                            url: "{{ session['server_ext'] }}/services/analysis/type/product/" +  id_type_prod,
                            success: function(data_prod)
                                {
                                let tmp_struct_prod = JSON.parse(JSON.stringify(struct_prod)) ;

                                tmp_struct_prod.id_data    = ind_products++ ;
                                tmp_struct_prod.type       = data_prod.id_data ;
                                tmp_struct_prod.stat       = 9 ;
                                tmp_struct_prod.ana        = data_ana.id_data ;

                                data_products.push(tmp_struct_prod) ;

                                // load new product in table
                                load_product( tmp_struct_prod ) ;
                                },
                            error: function(data_prod)
                                {
                                console.log("ERROR GET type product");
                                alert("{{ _("Erreur lors la récupération des produits pathologiques") }}") ;
                                }
                        } ) ;
                    }
                },
            error: function(data_ana)
                {
                console.log("ERROR GET det analysis");
                alert("{{ _("Erreur lors de la récupération des analyses") }}") ;
                }
        } ) ;
    }
} ) ;

// fix bug between jquery 3.6.0 and select2
$(document).on('select2:open', () => 
{
document.querySelector('.select2-search__field').focus() ;
} ) ;
{% endif %}

function load_analysis( data, bill_calc )
{
let tr_analysis = '' ;

    if (data.length < 1)
    {
    tr_analysis = '' ; //'<tr class=""><td colspan="8">' +
                  //'<div>Aucune donnée à afficher</div></td></tr>' ;
    }
    else
    {
    let obj    = data ;
    let tmp_tr = '<tr style="">' ;

    {% if entry == 'Y' %}
    let btn = '<i class="bi bi-x-circle-fill text-danger" title="{{ _("Supprimer") }}" onclick="del_analysis(' + obj.id_data + ');load_data(0);refresh_bill();" >' ;

    tmp_tr += create_td(obj.id_data, obj.id_data, "", "display:none;", 0) ;
    tmp_tr += create_td("", btn, "text-center", "", 0) ;
    tmp_tr += create_td("", obj.code, "text-center", "", 0) ;
    tmp_tr += create_td("", obj.name, "", "", 0) ;
    tmp_tr += create_td("", create_select("ana_emer_"+obj.id_data, opt_yorn, obj.emer, true), "text-center", "", 0) ;
    tmp_tr += create_td("", create_select("ana_req_"+obj.id_data, opt_yorn, obj.req, false), "text-center", "", 0) ;
    tmp_tr += create_td("", format_rate(obj.rate, obj.price), "text-center", "", 0) ;
    tmp_tr += create_td("", create_input("ana_price_"+obj.id_data, "number", obj.price, 0, 999999, "change_price"), "text-center", "", 0) ;
    tmp_tr += create_td("", select_yorn("ana_outsourced_"+obj.id_data, new_opt_yorn, obj.outsourced), "text-center", "", 0) ;
    {% else %}
    let urg   = obj.urgent ;
    let dem   = obj.demande ;
    let rate  = obj.cote_unite + obj.cote_valeur ;
    let outsourced = obj.outsourced ;

        if ( urg == 4 )
        urg = "{{ _("Oui") }}" ;
        else
        urg = "{{ _("Non") }}" ;

        if ( dem == 4 )
        dem = "{{ _("Oui") }}" ;
        else
        dem = "{{ _("Non") }}" ;

        if ( outsourced == 'Y' )
        outsourced = "{{ _("Oui") }}" ;
        else
        outsourced = "{{ _("Non") }}" ;

    tmp_tr += create_td(obj.id_data, obj.id_data, "", "display:none;", 0) ;
    tmp_tr += create_td("", obj.code, "text-center", "", 0) ;
    tmp_tr += create_td("", obj.nom, "", "", 0) ;
    tmp_tr += create_td("", urg, "text-center", "", 0) ;
    tmp_tr += create_td("", dem, "text-center", "", 0) ;
    tmp_tr += create_td("", format_rate(rate, obj.prix), "text-center", "", 0) ;
    tmp_tr += create_td("", obj.prix, "text-center", "", 0) ;
    tmp_tr += create_td("", outsourced, "text-center", "", 0) ;
    {% endif %}

    tmp_tr += '</tr>' ;

        {% if session['pref_bill'] == '1' %}
        if (bill_calc)
        {
        bill_price  += obj.price ;
        bill_remain += obj.price ;
        }
        {% endif %}

    tr_analysis += tmp_tr ;
    }

$("#tbody_analysis").append(tr_analysis) ;
$("#table_analysis").tablesorter() ;  // sort only data on screen
}

{% if entry == 'Y' %}
function del_analysis( id_data )
{
    if ( window.confirm("{{ _("Merci de confirmer la suppression") }}") )
    {
        for( i in data_analysis )
        {
            if (data_analysis[i].id_data == id_data)
            {
            {% if session['pref_bill'] == '1' %}
            bill_price  -= data_analysis[i].price ;
            bill_remain -= data_analysis[i].price ;

            refresh_bill() ;
            {% endif %}

                // remove all specimen associated
                for( k in data_products )
                {
                    if (data_products[k].ana == id_data)
                    data_products.splice(k, 1);
                }

                // remove analysis choice in opt_ana
                for( j in opt_ana )
                { 
                    if ( opt_ana[j].id_data == id_data )
                    {
                    opt_ana.splice(j, 1) ;
                    break ;
                    }
                }

            // remove analysis in data_analysis
            data_analysis.splice(i, 1);

            break ;
            }
        }
    }
    else
    return false ;
}
{% endif %}

function load_product( data )
{
let tr_product = '' ;

    if (data.length < 1)
    {
    tr_product = '' ; //'<tr class=""><td colspan="4">' +
                  //'<div>Aucune donnée à afficher</div></td></tr>' ;
    }
    else
    {
    let obj = data ;

        if ( obj.id_data >= 0 )
        {
        let tmp_tr = '<tr style="vertical-align:middle;">' ;

        {% if entry == 'Y' %}
        let btn = '<i class="bi bi-x-circle-fill text-danger" title="{{ _("Supprimer") }}" onclick="del_product(' + obj.id_data + ');load_data(0);" >' ;

        // displayed on 2 lines
        tmp_tr += create_td(obj.id_data, obj.id_data, "", "display:none;", 0) ;
        tmp_tr += create_td("", btn, "text-center", "", 0) ; // actions
        tmp_tr += create_td("", create_input("prod_dateSamp_"+obj.id_data, "datetime-local", obj.dateSamp, 0, 0, ""), "text-center", "", 0) ; // input date prel
        tmp_tr += create_td("", create_select("prod_type_"+obj.id_data, {{ ihm['products']|safe }}, obj.type, true), "text-center", "", 0) ; // select product
        tmp_tr += create_td("", create_input("prod_code_"+obj.id_data, "text", obj.code, 0, 0, ""), "text-center", "", 0) ; // input code product
        tmp_tr += create_td("", create_input("prod_sampler_"+obj.id_data, "text", obj.sampler, 0, 0, ""), "text-center", "", 0) ; // input text preleveur 
        tmp_tr += '</tr><tr style="vertical-align:middle;">' ;
        tmp_tr += create_td("", create_select("prod_ana_"+obj.id_data, opt_ana, obj.ana, true), "text-center", "", 0) ;
        tmp_tr += create_td("", create_input("prod_dateReceipt_"+obj.id_data, "datetime-local", obj.dateReceipt, 0, 0, "", 0), "text-center", "") ; // input date recept
        tmp_tr += create_td("", create_select("prod_stat_"+obj.id_data, {{ ihm['products_statut']|safe }}, obj.stat, true), "text-center", "", 0) ; // select statut
        tmp_tr += create_td("", create_input("prod_comm_"+obj.id_data, "text", obj.comm, 0, 0, ""), "text-center", "", 2) ; // input text comm
        {% else %}
        tmp_tr += create_td(obj.id_data, obj.id_data, "", "display:none;", 0) ;
        tmp_tr += create_td("", obj.samp_date, "text-center", "", 0) ;
        tmp_tr += create_td("", obj.code, "text-center", "", 0) ;
        tmp_tr += create_td("", obj.type_prod, "text-center", "", 0) ;
        tmp_tr += create_td("", obj.preleveur, "text-center", "", 0) ;
        tmp_tr += '</tr><tr style="vertical-align:middle;">' ;
        tmp_tr += create_td("", obj.code, "text-center", "", 0) ;
        tmp_tr += create_td("", obj.samp_receipt_date, "text-center", "", 0) ;
        tmp_tr += create_td("", obj.stat_prod, "text-center", "", 0) ;
        tmp_tr += create_td("", obj.commentaire, "text-center", "", 2) ;
        {% endif %}

        tmp_tr += '</tr>' ;

        tr_product += tmp_tr ;
        }
    }

$("#tbody_product").append(tr_product) ;
}

{% if entry == 'Y' %}
function del_product( id_data )
{
    if ( window.confirm("{{ _("Merci de confirmer la suppression") }}") )
    {
        for( i in data_products )
        {
            if (data_products[i].id_data == id_data)
            {
            data_products.splice(i, 1);

            break ;
            }
        }
    }
    else
    return false ;
}
{% endif %}

function create_td(id, val, cls, style, nb_colspan)
{
style = "font-size:14px;vertical-align:middle;padding-start:.3rem;padding-end:.3rem;" + style ;

colspan = "" ;

    if (nb_colspan > 1) colspan = ' colspan="' + nb_colspan + '"';

let tmp_td = '<td class="' + cls + '" id="' + id + '" style="' + style + '"' + colspan + '>' +
             '<div>' + val + '</div></td>' ;

return tmp_td ;
}

{% if entry == 'Y' %}
function create_select(id, l_options, val_select, opt_empty)
{
let tmp_select = '<select class="form-select" style="font-size:14px;" id="' + id + '" onChange="change_data(this)">' ;

    if (opt_empty)
    tmp_select += '<option value="0"></option>' ;

    for( i in l_options )
    {
    let selected = "" ;

        if (l_options[i].id_data == val_select)
        selected = "selected" ;

    tmp_select += '<option value="' + l_options[i].id_data + '" ' + selected + ' >' + l_options[i].label + '</option>' ;
    }

tmp_select += '</select>' ;

return tmp_select ;
}

function select_yorn(id, l_options, val_select)
{
let tmp_select = '<select class="form-select" style="font-size:14px;" id="' + id + '" onChange="change_data(this)">' ;

    for( i in l_options )
    {
    let selected = "" ;

        if (l_options[i].value == val_select)
        selected = "selected" ;

    tmp_select += '<option value="' + l_options[i].value + '" ' + selected + ' >' + l_options[i].label + '</option>' ;
    }

tmp_select += '</select>' ;

return tmp_select ;
}

function create_input(id, type, val, min, max, fct)
{
let other_fct = '' ;

    // example : onchange for price
    if ( fct != "" )
    other_fct += fct + '(this);" ' ;

let tmp_input = '<input class="form-control form-lbk" id="' + id + '" type="' + type + '" value="' + val + '" onfocus="old_value=this.value;" onChange="change_data(this);' + other_fct + '"' ;

    if (type == "number")
    tmp_input += 'min="' + min + '" max="' + max + '" style="font-size:14px;min-width:50px;max-width:100px;text-align:right;"' ;
    else if (type == "datetime-local")
    tmp_input += 'style="font-size:14px;min-width:50px;"' ;
    else
    tmp_input += 'style="font-size:14px;min-width:50px;"' ;

tmp_input += '>' ;

return tmp_input ;
}

function change_price( elem )
{
{% if session['pref_bill'] == '1' %}
// Get new value from input
let val = $(elem).val() ;

bill_price += ( Number(val) - Number(old_value) )  ;

// Update old value
old_value = Number(val) ;

refresh_bill();
{% endif %}
}

function change_per_discount( elem )
{
{% if session['pref_bill'] == '1' %}
// Get new value from input
let val = $(elem).val() ;

// Update old discount
old_discount = Number(val) ;

refresh_bill();
{% endif %}
}

function change_per_insurance( elem )
{
{% if session['pref_bill'] == '1' %}
// Get new value from input
let val = $(elem).val() ;

// Update old insurance
old_insurance = Number(val) ;

refresh_bill();
{% endif %}
}

function calc_remain()
{
{% if session['pref_bill'] == '1' %}
    if ( old_discount > 0 && old_insurance > 0 )
    bill_remain = (bill_price - (bill_price * Number(old_discount) / 100)) * (100 - Number(old_insurance)) / 100 ;
    else if ( old_discount > 0 )
    bill_remain = bill_price - (bill_price * Number(old_discount) / 100) ;
    else if ( old_insurance > 0 )
    bill_remain = bill_price - (bill_price * Number(old_insurance) / 100) ;
    else
    bill_remain = bill_price ;
{% endif %}
}

function change_data( elem )
{
// Get new value from select or input
let val = $(elem).val() ;

// Change value in data structure
let id_elem = elem.id ;
let split_id = id_elem.split("_") ;
let id_data  = split_id[split_id.length -1] ; 

    if ( split_id[0] == "ana" )
    {
        for( i in data_analysis )
        {
            if (data_analysis[i].id_data == id_data )
            {
                if ( split_id[1] == "emer" )
                data_analysis[i].emer = val ;
                else if ( split_id[1] == "req" )
                data_analysis[i].req = val ;
                else if ( split_id[1] == "price" )
                data_analysis[i].price = val ;
                else if ( split_id[1] == "outsourced" )
                data_analysis[i].outsourced = val ;

            break ;
            }
        }
    }
    else if ( split_id[0] == "prod" )
    {
        for( i in data_products )
        {
            if (data_products[i].id_data == id_data )
            {
                if ( split_id[1] == "code" )
                data_products[i].code = val ;
                else if ( split_id[1] == "type" )
                data_products[i].type = val ;
                else if ( split_id[1] == "stat" )
                data_products[i].stat = val ;
                else if ( split_id[1] == "dateSamp" )
                data_products[i].dateSamp = val ;
                else if ( split_id[1] == "dateReceipt" )
                data_products[i].dateReceipt = val ;
                else if ( split_id[1] == "sampler" )
                data_products[i].sampler = val ;
                else if ( split_id[1] == "ana" )
                data_products[i].ana = val ;
                else if ( split_id[1] == "comm" )
                data_products[i].comm = val ;

            break ;
            }
        }
    }
}
{% endif %}

function format_rate(rate, price)
{
return rate + '(' + price + ')' ;
}

{% if entry == 'Y' %}
function refresh_bill()
{
{% if session['pref_bill'] == '1' %}
calc_remain() ;

$("#bill_price").val(bill_price)   ;
$("#bill_remain").val(bill_remain) ;
{% endif %}
}

function new_prod()
{
let tmp_struct_prod = JSON.parse(JSON.stringify(struct_prod)) ;

tmp_struct_prod.id_data = ind_products++ ;

data_products.push(tmp_struct_prod) ;

load_product( tmp_struct_prod ) ;
}
{% endif %}

function load_data( bill_calc )
{
// clear table tbody
$("#tbody_analysis").empty() ;
$("#tbody_product").empty() ;

    for( i in data_analysis )
    {
    load_analysis( data_analysis[i], bill_calc ) ;
    }

    for( i in data_products )
    {
    load_product( data_products[i] ) ;
    }
}

{% if entry == 'Y' %}
$("input[type=radio][name=parcel]").change(function() 
{
    if (this.value == '4') 
    {
    $("#parcel_id").val("")   ;
    $("#parcel_date").val("") ;
    $("#colis-group").show()  ;
    }
    else if (this.value == '5') 
    {
    // hide identification and date reception
    $("#parcel_id").val("")   ;
    $("#parcel_date").val("") ;
    $("#colis-group").hide()  ;
    }
} ) ;
{% endif %}

{% if entry == 'Y' %}
function save_requests()
{
var id_user       = {{ session['user_id']|safe}} ;
var user_role     = "{{ session['user_role']|safe }}"  ;
var id_patient    = {{ args['patient']['id_data']|safe }} ;
var type          = 184 ; // INTERNAL
var date_record   = $("#date_record").val() ;
var id_med        = $("#search_doctor").val() ;
var date_prescr   = $("#date_prescr").val() ;
var parcel_id     = $("#parcel_id").val() ;
var parcel_date   = $("#parcel_date").val() ;
var comm          = JSON.stringify( $.trim( $("#comm").val() ) ) ;
var parcel        = $("input[type='radio'][name='parcel']:checked").val() ;
var price         = {% if session['pref_bill'] == '1' %}$("#bill_price").val(){% else %} 0{%endif%};
var discount      = {% if session['pref_bill'] == '1' %}$("#discount").val(){% else %} 0{%endif%};
var per_discount  = {% if session['pref_bill'] == '1' %}$("#per_discount").val(){% else %} 0{%endif%};
var per_insurance = {% if session['pref_bill'] == '1' %}$("#per_insurance").val(){% else %} 0{%endif%};
var bill_remain   = {% if session['pref_bill'] == '1' %}$("#bill_remain").val(){% else %} 0{%endif%};
var receipt_num   = $("#receipt_num").val() ;
var date_hosp     = $("#date_hosp").val() ;
var service_int   = $("#service_int").val() ;
var bed_num       = $("#bed_num").val() ;
var rec_hosp_num  = $("#rec_hosp_num").val() ;
var bill_num      = "" ;
var stat          = 181 ;
var rec_custody   = $("input[type='radio'][name='rec_custody']:checked").val() ;
var rec_num_int   = $("#rec_num_int").val() ;

    if (id_med == null || id_med == "")
    id_med = 0 ;

    if (parcel == null)
    parcel = 5 ;
    else if (parcel == 4 && parcel_date == "")
    {
    alert( "{{ _("Veuillez sélectionner une date et heure de réception du colis") }}" ) ;
    return false ;
    }

    if (data_analysis.length < 1)
    {
    alert( "{{ _("Veuillez sélectionner au moins une analyse") }}" ) ;
    return false ;
    }

    if (per_discount == "")
    per_discount = 0 ;

    if (per_insurance == "")
    per_insurance = 0 ;

    if (bed_num == "")
    bed_num = 0 ;

    // date_record required
    if (date_record == "")
    {
    alert( "{{ _("Veuillez sélectionner une date de réception du dossier") }}" ) ;
    return false ;
    }

    // date_prescr required
    if (date_prescr == "")
    {
    alert( "{{ _("Veuillez sélectionner une date de prescription") }}" ) ;
    return false ;
    }

    // type and status required
    for( i in data_products )
    {
        /* USELESS 15/02/2022
        if (data_products[i].code == "")
        {
        alert( "{{ _("Veuillez renseigner le code de prélèvement") }}" ) ;
        return false ;
        }
        */

        if (data_products[i].type == 0)
        {
        alert( "{{ _("Veuillez renseigner le type du produit") }}" ) ;
        return false ;
        }

        if (data_products[i].stat == 0)
        {
        alert( "{{ _("Veuillez renseigner le statut du produit") }}" ) ;
        return false ;
        }

        /* ISSUE 1 17/10/2020
        if (data_products[i].dateReceipt == "")
        {
        alert( "{{ _("Veuillez renseigner toutes les dates de réception") }}" ) ;
        return false ;
        }

        if (data_products[i].sampler == "")
        {
        alert( "{{ _("Veuillez renseigner toutes les identités des préleveurs") }}" ) ;
        return false ;
        }
        */
    }

    if ( $.isEmptyObject(data_products) )
    alert( "{{ _("Avertissement : Ce dossier n'est associé à aucun prélèvement") }}" ) ;

    // confirm if user wants validate this record
    if ( window.confirm("{{ _("Merci de confirmer la création et validation de ce dossier") }}") )
    {
    var param = '{ "id_owner":' + id_user + ', ' +
                  '"id_patient":' + id_patient  + ', ' +
                  '"type":' + type + ', ' +
                  '"date_record":"' + date_record + '", ' +
                  '"id_med":' + id_med + ', ' +
                  '"date_prescr":"' + date_prescr + '", ' +
                  '"parcel_id":"' + parcel_id + '", ' +
                  '"parcel_date":"' + parcel_date + '", ' +
                  '"comm":' + comm + ', ' + // NO QUOTE DUE TO STRINGIFY PROCESS
                  '"parcel":' + parcel + ', ' +
                  '"price":' + price + ', ' +
                  '"discount":' + discount + ', ' +
                  '"percent_discount":' + per_discount + ', ' +
                  '"percent_insurance":' + per_insurance + ', ' +
                  '"bill_remain":' + bill_remain + ', ' +
                  '"receipt_num":"' + receipt_num + '", ' +
                  '"bill_num":"' + bill_num + '", ' +
                  '"date_hosp":"' + date_hosp + '", ' +
                  '"service_int":"' + service_int + '", ' +
                  '"bed_num":' + bed_num + ', ' +
                  '"rec_hosp_num":"' + rec_hosp_num + '", ' +
                  '"stat":' + stat + ', ' +
                  '"rec_custody":"' + rec_custody + '", ' +
                  '"rec_num_int":"' + rec_num_int + '", ' +
                  '"rec_modified":"N"}' ;

        // popup wait
        $("#dial-wait").off('shown.bs.modal') ;
        $("#dial-wait").modal("show") ;

        // Send record information
        $.ajax( 
        {
            // CREATE Record
            type: "POST",
            url: "{{ session['server_ext'] }}/services/record/det/0",
            dataType: 'json',
            contentType: "application/json; charset=utf-8",
            data: param,
            success: function(ret_rec)
            {
            var id_rec = ret_rec.id_rec ;

            var param_list_ana = '{ "list_ana":[';

                // Add analysis
                for( i in data_analysis )
                {
                    if (data_analysis[i] != null)
                    {
                        if (i > 0 && param_list_ana.slice(-1) != "[" )
                        param_list_ana += ', ' ;

                    var param_ana = '{ "id_owner":' + id_user + ', ' +
                                      '"id_rec":' + id_rec  + ', ' +
                                      '"id_ana":' + data_analysis[i].id_data + ', ' +
                                      '"price":' + data_analysis[i].price + ', ' +
                                      '"paid": 5, ' +
                                      '"emer":' + data_analysis[i].emer + ', ' +
                                      '"req":' + data_analysis[i].req + ', ' +
                                      '"outsourced":"' + data_analysis[i].outsourced + '"}' ;

                    param_list_ana += param_ana ;
                    }
                }

            param_list_ana += ' ] }';

                // Send analysis information
                $.ajax( 
                {
                    // INSERT ANALYSIS REQUESTED
                    type: "POST",
                    url: "{{ session['server_ext'] }}/services/analysis/list/req",
                    dataType: 'json',
                    contentType: "application/json; charset=utf-8",
                    data: param_list_ana,
                    success: function(ret_ana)
                    {
                    var param_list_prod = '{ "list_prod":[ ';

                        for( i in data_products )
                        {
                            if (data_products[i] != null)
                            {
                                if (i > 0)
                                param_list_prod += ', ' ;

                            var param_prod = '{ "id_owner":' + id_user + ', ' +
                                               '"code":"' + data_products[i].code + '", ' +
                                               '"date_samp":"' + data_products[i].dateSamp + '", ' +
                                               '"type_samp":"' + data_products[i].type + '", ' +
                                               '"ana":' + data_products[i].ana + ', ' +
                                               '"stat":' + data_products[i].stat + ', ' +
                                               '"id_rec":' + id_rec + ', ' +
                                               '"sampler":"' + data_products[i].sampler + '", ' +
                                               '"date_receipt":"' + data_products[i].dateReceipt + '", ' +
                                               '"time_receipt":"", ' +
                                               '"comm":"' + data_products[i].comm + '", ' +
                                               '"locat_samp":"", ' +
                                               '"locat_samp_more":"", ' +
                                               '"location":""}' ;

                            param_list_prod += param_prod ;
                            }
                        }

                    param_list_prod += ' ] }';

                        // Send product information
                        $.ajax( 
                        {
                            // INSERT SAMPLES REQUESTED
                            type: "POST",
                            url: "{{ session['server_ext'] }}/services/product/list/req",
                            dataType: 'json',
                            contentType: "application/json; charset=utf-8",
                            data: param_list_prod,
                            success: function(ret_prod)
                            {
                            let param_res = '{ "id_owner":' + id_user + ', "user_role":"' + user_role + '"}' ;

                                // create in DB list of results to enter and corresponding validation
                                $.ajax(
                                {
                                    type : "POST",
                                    url : "{{ session['server_ext'] }}/services/result/create/" + id_rec,
                                    dataType: 'json',
                                    contentType: "application/json; charset=utf-8",
                                    data: param_res,
                                    success : function(response)
                                    {
                                    let param_stat = '{ "stat":182 }' ; 

                                        // update record stat 181 to 182
                                        $.ajax(
                                        {
                                            type : 'POST',
                                            url : "{{ session['server_ext'] }}/services/record/stat/" + id_rec,
                                            dataType: 'json',
                                            contentType: "application/json; charset=utf-8",
                                            data: param_stat,
                                            success : function(response)
                                            {
                                                $("#dial-wait").modal("hide") ;

                                            // Redirection to adminsitrative page
                                            window.location.href = "{{ session['server_ext'] }}/administrative-record/I/" + id_rec ;
                                            },
                                            error: function(response)
                                            {
                                                $("#dial-wait").modal("hide") ;

                                            console.log("ERROR record stat") ;
                                            alert("{{ _("Une erreur est survenue lors du changement de statut du dossier") }}") ;
                                            }
                                        } ) ;
                                    },
                                    error: function(response)
                                    {
                                        $("#dial-wait").modal("hide") ;

                                    console.log("ERROR result create") ;
                                    alert("{{ _("Une erreur est survenue lors de la création des résultats") }}") ;
                                    }
                                } ) ;
                            },
                            error: function(ret_prod)
                            {
                                $("#dial-wait").modal("hide") ;

                            console.log("ERROR product list req") ;
                            alert("{{ _("Une erreur est survenue lors de l'enregistrement des prélèvements") }}") ;
                            } 
                        } ) ;
                    },
                    error: function(ret_ana)
                    {
                        $("#dial-wait").modal("hide") ;

                    console.log("ERROR analysis list req") ;
                    alert("{{ _("Une erreur est survenue lors de l'enregistrement des analyses") }}") ;
                    } 
                } ) ;
            },
            error: function(ret_rec)
            {
                $("#dial-wait").modal("hide") ;

            console.log("ERROR record det") ;
            alert("{{ _("Une erreur est survenue lors de l'enregistrement du dossier") }}") ;
            }
        } ) ;
    }
    else
    return false;
}
{% endif %}

{% if entry == 'N' %}
function valid_requests()
{
let id_user  = {{ session['user_id']|safe}} ;
let user_role = "{{ session['user_role']|safe }}"  ;
let param_res = '{ "id_owner":' + id_user + ', "user_role":"' + user_role + '"}' ;

    // popup wait
    $("#dial-wait").off('shown.bs.modal') ;
    $("#dial-wait").modal("show") ;

    // create in DB list of results to enter and corresponding validation
    $.ajax(
    {
        type : 'POST',
        url : "{{ session['server_ext'] }}/services/result/create/" + {{ args['record']['id_data'] }},
        dataType: 'json',
        contentType: "application/json; charset=utf-8",
        data: param_res,
        success : function(response)
        {
        let param_stat = '{ "stat":182 }' ; 

            // update record stat 181 to 182
            $.ajax(
            {
                type : 'POST',
                url : "{{ session['server_ext'] }}/services/record/stat/" + {{ args['record']['id_data'] }},
                dataType: 'json',
                contentType: "application/json; charset=utf-8",
                data: param_stat,
                success : function(response)
                {
                    $("#dial-wait").modal("hide") ;

                window.location.href = "{{ session['server_ext'] }}/administrative-record/I/" + {{ args['record']['id_data'] }} ;
                },
                error: function(response)
                {
                    $("#dial-wait").modal("hide") ;

                console.log("ERROR record stat") ;
                alert("{{ _("Une erreur est survenue lors du changement de statut du dossier") }}") ;
                }
            } ) ;
        },
        error: function(response)
        {
            $("#dial-wait").modal("hide") ;

        console.log("ERROR result create") ;
        alert("{{ _("Une erreur est survenue lors de la création des résultats") }}") ;
        }
    } ) ;
}
{% endif %}

function new_doctor()
{
window.open("{{ session['server_ext'] }}/det-doctor/0", "_blank") ;
}

function return_home()
{
window.location.href = "{{ session['server_ext'] }}/sigl/homepage";
}

$( document ).ready( function()
{
    {% if entry == 'Y' %}
    $("#date_record").val( "{{ now|datetime_now }}" ) ;
    {% else %}
        {% if session['record_period'] == 1070 %} // Month period
        let num_dos = {{ args['record']['num_dos_mois'] }} ;
        {% else %} // Annual period
        let num_dos = {{ args['record']['num_dos_an'] }} ;
        {% endif %}

        num_dos = fmt_num_rec( num_dos, {{ session['record_format'] }}, {{ session['record_period'] }} ) ;

        $("#rec_num").text( num_dos ) ;
    {% endif %}
    load_data(1) ;
} ) ;
</script>
{% endblock %}

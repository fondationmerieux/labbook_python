{% extends "skeleton.html" %}

{% block head %}
{{ super() }}
    <title>{{ _("Nouvelle demande hospitalisé") }}</title>
    <link href="{{ url_for('static', filename='vendor/css/select2.min.css') }}" rel="stylesheet" />
    <script src="{{ url_for('static', filename='vendor/js/select2.min.js') }}" nonce="{{ session['nonce'] }}"></script>
{% endblock %}

{% block content %}
<div id="content">
    <div class="inner">
        <div id="main" style="opacity: 1;">
            <h2 class="page-title page-title-{{ session['user_role']|safe }}"><span>{{ _("Demande d'analyses patient hospitalisé") }}</span></h2>
            <form autocomplete="off">
                <div class="panel-heading row">
                    <h3 class="panel-title">{{ _("Chercher un patient") }}</h3>
                </div>
                <div class="panel-patient row mt-3">
                    <div class="col-10">
                        <div class="form-group row">
                            <label for="search_patient" class="col-form-label col-4 text-right">{{ _("Nom, prénom ou code du patient") }}</label>
                            <div>
                                <select id="search_patient" style="width:450px"></select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <div class="float-left" style="margin-left:0px;">
                            <input type="button" onclick="return_home();" id="exit" class="btn btn-{{ session['user_role']|safe }}" value="{{ _("Quitter") }}">
                        </div>
                        <div class="float-right mr-2">
                            <input type="button" onclick="new_pat();" id="new_patient" class="btn btn-{{ session['user_role']|safe }}" value="{{ _("Nouveau patient") }}">
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div><!-- close content -->
{% endblock %}

{% block add_script %}
<script type="text/javascript" nonce="{{ session['nonce'] }}">
$("#search_patient").select2(
{
    placeholder: "{{ _("Cliquer pour commencer une recherche") }}",
    tags: false,
    multiple: false,
    tokenSeparators: [','],
    minimumInputLength: 2,
    ajax: {
        url: "{{ session['server_ext'] }}/services/patient/search",
        type: "POST",
        dataType: "json",
        contentType: "application/json; charset=utf-8",
        term: $("#search_patient").text(),
        data: function (params) {
            return JSON.stringify({
                term: params.term
            });
        },
        processResults: function (data) {
            return {
                // data need id key if not no focus selection displayed
                results: data
            } ;
        }
    },
    templateResult: formatRepo
} ) ;

function formatRepo(repo)
{
    if (repo.loading)
    return repo.text ;

var ident = "" ;

    if (repo.prenom)
    ident += repo.prenom + " " ;

    if (repo.nom)
    ident += repo.nom ;

var code = "" ;

    if (repo.code)
    code += "[" + repo.code + "]" ;

    if (repo.code_patient)
    code += " - code patient : " + repo.code_patient ;

var info = "" ;

    if (repo.ddn)
    info += repo.ddn + " " ; // TODO change format date ?

var display = $(
    "<div class='select2-result-repository clearfix'>" +
        "<div class='select2-result-repository__meta'>" +
            "<div class='select2-result-repository__title'><b>" + ident + " " + code + "</b></div>" +
            "<div class='select2-result-repository__description'>" + info + "</div>" +
        "</div>" +
    "</div>") ;

return display ;
}

$("#search_patient").on("select2:select", function (e) 
{
  var id_pat = $(e.currentTarget).val();
  window.location.href = "{{ session['server_ext'] }}/{{ session['redirect_name'] }}/det-req-int/Y/" + id_pat ;
} ) ;

function new_pat() 
{
window.location.href = "{{ session['server_ext'] }}/{{ session['redirect_name'] }}/det-patient/I/0";
}

function return_home()
{
window.location.href = "{{ session['server_ext'] }}/sigl/homepage";
}
</script>
{% endblock %}

{% extends "skeleton.html" %}

{% block head %}
{{ super() }}
    {% block title %}
    <title>Details demande d'analyses</title>
    {% endblock %}
    <link rel="stylesheet" href="{{ session['server_ext'] }}/theme.default.css" />
    <link href="{{ session['server_ext'] }}/datepicker/css/bootstrap-datepicker3.min.css" media="screen, print" rel="stylesheet" type="text/css" />
    <link href="{{ session['server_ext'] }}/{{ session['redirect_name'] }}/static/vendor/css/select2.min.css" rel="stylesheet" />
    <script type="text/javascript" src="{{ session['server_ext'] }}/{{ session['redirect_name'] }}/static/vendor/js/select2.min.js"></script>
    <script type="text/javascript" src="{{ session['server_ext'] }}/jquery.tablesorter.min.js"></script>
{% endblock %}

{% block tag_body %}<body class="yui3-skin-sam yui-skin-sam {{ session['user_role']|safe }}">{% endblock %}
{% block content %}
<div id="content">
    <div class="inner">
        <div id="main" style="opacity: 1;">
            <h2 class="page-title form-patient_externe"><span>Demande d'analyses patient externe</span></h2>
            <form id="form_main" class="vzn-form form-horizontal row">
                {% if entry == 'N' %}
                <div class="statictext undefined">
                    <span>Dossier :</span>
                </div>
                <div class="form-control-static filed readonly-field div-inline label-rightMargin undefined" id="num-dos-ro">
                    <span>1</span>
                </div>
                {% endif %}
                <div class="canvas">
                    <div class"vzn-row">
                        <div class="cell" style="width: 360px;">
                            <div id="pat-group-group" class="panel panel-1 panel-primary" style="">
                                <div class="panel-heading">
                                    <h3 class="panel-title">Identité</h3>
                                </div>
                                <div class="panel-body " id="pat-group-group_body">
                                    <div class="row">
                                        <div id="pat-group" class="col-xs-12">
                                            <div class="form-group form-inline">
                                                <div class="form-control-static field readonly-field col-md-4 col-lg-3" id="pat-code-ro" style="">
                                                    <span>{{ args['code_patient'] }}</span>
                                                </div>
                                                <div class="form-control-static field readonly-field col-md-4 col-lg-3" id="anon-code-ro" style="">
                                                    <span>{{ args['code'] }}</span>
                                                </div>
                                            </div>
                                            <div class="panel panel-2 panel-primary" style="transition-duration: 0s; transition-timing-function: ease; transition-delay: 0s; opacity: 1;">
                                                <div class="panel-body ">
                                                    <div class="row">
                                                        <div class="form-inline col-xs-12">
                                                            <div class="form-control-static field readonly-field div-inline label-rightMargin undefined" style="">
                                                                <span>{{ args['prenom'] }} {{ args['nom'] }}</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="panel panel-2 panel-primary" style="display:none; transition-duration: 0s; transition-timing-function: ease; transition-delay: 0s; opacity: 0;">
                                                <div class="panel-body">
                                                    <div class="row">
                                                        <div class="form-inline col-xs-12">
                                                            <div class="statictext undefined">
                                                                <span>Patient anonyme.</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="panel panel-2 panel-primary" style="">
                                                <div class="panel-body ">
                                                    <div class="row">
                                                        <div class="form-inline col-xs-12">
                                                            <div class="statictext undefined">
                                                                <span>Né(e) le</span>
                                                            </div>
                                                            <div class="form-control-static field readonly-field div-inline label-rightMargin undefined" style="">
                                                                <span>{{ args['ddn']|date_format }}</span>
                                                            </div>
                                                            <div class="statictext undefined">
                                                                <span>-</span>
                                                            </div>
                                                            <div class="form-control-static field readonly-field div-inline label-rightMargin undefined" style="">
                                                                <span>{{ args['age'] }}</span>
                                                            </div>
                                                            <div class="statictext undefined">
                                                                <span></span>
                                                            </div>
                                                            <div class="form-control-static field readonly-field div-inline label-rightMargin undefined" style="">
                                                                <span>{% if args['unite'] == 1037 %}Années
                                                                      {% elif args['unite'] == 1036 %}Mois
                                                                      {% elif args['unite'] == 1035 %}Semaines
                                                                      {% elif args['unite'] == 1034 %}Jours{% endif %}</span>
                                                            </div>
                                                            <div class="statictext undefined">
                                                                <span>.</span>
                                                            </div>
                                                            <div class="form-control-static field readonly-field div-inline label-rightMargin undefined" style="">
                                                                <span>{% if args['sexe'] == 1 %}Masculin
                                                                      {% elif args['sexe'] == 2 %}Féminin
                                                                      {% elif args['sexe'] == 3 %}Inconnu{% endif %}</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            {% if entry == 'Y' %}
                                            <div class="form-group button">
                                                <input type="button" onclick="change_pat({{ args['id_data'] }});" class="btn undefined btn-default" value="Modifier le dossier du patient">
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="cell" style="width: 470px;">
                            <div id="presc-group-group" class="panel panel-1 panel-primary" style="">
                                <div class="panel-heading"><h3 class="panel-title">Prescription</h3></div>
                                <div class="panel-body " id="presc-group-group_body">
                                    <div class="row">
                                        <div id="presc-group" class="col-xs-12">
                                            <div class="form-group">
                                                <label class="mandatory control-label col-lg-6 col-md-6 col-sm-6" style="">
                                                    <span data-field="date_dos">Date de réception du dossier *</span>
                                                </label>
                                                <div class="field date-fields form-inline col-lg-6 col-md-6 col-sm-6">
                                                    {% if entry == 'Y' %}
                                                    <input id="date_record" class="voo_date voo_date_field_1 form-control" type="date" maxlength="10" size="10" value="" placeholder="" style="">
                                                    {% else %}
                                                    data_date_recept
                                                    {% endif %}

                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label class="mandatory control-label col-lg-6 col-md-6 col-sm-6" style="">
                                                    <span data-field="date_prescription">Date de prescription *</span>
                                                </label>
                                                <div class="field date-fields form-inline col-lg-6 col-md-6 col-sm-6">
                                                    {% if entry == 'Y' %}
                                                    <input class="voo_date voo_date_field_1 form-control" type="date" maxlength="10" size="10" value="" placeholder="" style="color: #888;">
                                                    {% else %}
                                                    data_date_prescription
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <div class="form-group" id="prat-search">
                                                <div class="statictext control-label col-lg-6 col-md-6 col-sm-6 text-right">
                                                    <span>Praticien</span>
                                                </div>
                                                <div class="field col-lg-6 col-md-6 col-sm-6">
                                                    {% if entry == 'Y' %}
                                                    <select id="search_doctor" style="width:400px"></select>
                                                    {% else %}
                                                    data_doctor
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label class="control-label col-lg-6 col-md-6 col-sm-6" style=""><span>Colis</span></label>
                                                <div class="radio-group col-lg-6 col-md-6 col-sm-6">
                                                    {% if entry == 'Y' %}
                                                    <label class="radio-inline undefined"><input type="radio" name="colis" value="4">Oui</label>
                                                    <label class="radio-inline undefined"><input type="radio" name="colis" value="5">Non</label>
                                                    {% else %}
                                                    data_colis
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <div id="colis-group" class="panel-primary" style="display:none;">
                                                <div class="panel-body " id="colis-group_body">
                                                    <div class="row">
                                                        <div class="col-xs-12">
                                                            <div class="form-group">
                                                                <label class="control-label col-lg-6 col-md-6 col-sm-6" style="">
                                                                    <span data-field="id_colis">Identification du colis</span>
                                                                </label>
                                                                <div class="field col-lg-6 col-md-6 col-sm-6">
                                                                    <input id="parcel_id" type="text" value="" maxlength="30" class="form-control" style="width: 240px;" null="">
                                                                </div>
                                                            </div>
                                                            <div class="form-group">
                                                                <label class="control-label col-lg-6 col-md-6 col-sm-6" style="">
                                                                    <span data-field="date_reception_colis">Date de réception du colis</span>
                                                                </label>
                                                                <div class="field date-fields form-inline col-lg-6 col-md-6 col-sm-6">
                                                                    <input  id="parcel_date" class="voo_date voo_date_field_1 form-control" type="date" maxlength="10" size="10" value="" placeholder="" style="color: #888;">
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                           </div>
                                        </div>
                                   </div>
                                </div>
                            </div>
                        </div>
                        <div class="clear"></div>
                    </div>
                </div>

                <div id="analyse-group-group" class="panel panel-1 panel-primary" style="">
                    <div class="panel-heading"><h3 class="panel-title">Analyses et actes de prélèvement</h3></div>
                    <div class="panel-body " id="analyse-group-group_body">
                        <div class="row">
                            <div id="analyse-group" class="col-xs-12">
                                {% if entry == 'Y' %}
                                <div class="form-group">
                                    <div class="statictext col-lg-2 control-label"><span>Rechercher une analyse</span></div>
                                    <div class="field col-lg-2">
                                        <select id="search_analysis" style="width:450px"></select>
                                    </div>
                                </div>
                                {% endif %}
                                <div class="form-group">
                                    <div class="statictext col-md-1 title"><span>Analyses</span></div>
                                </div>
                                <div class="listing table-responsive yui-dt" id="listing_analyse">
                                    <table id="table_analysis" class="tablesorter">
                                        <colgroup>{% if entry == 'Y' %}<col>{% endif %}<col><col><col><col><col><col><col></colgroup>
                                        <thead>
                                            <tr>
                                                <th style="display:none;">
                                                    <div>
                                                        <span>id_data</span>
                                                    </div>
                                                </th>
                                                {% if entry == 'Y' %}
                                                <th>
                                                    <div>
                                                        <span>Action</span>
                                                    </div>
                                                </th>
                                                {% endif %}
                                                <th>
                                                    <div>
                                                        <span>Code</span>
                                                    </div>
                                                </th>
                                                <th>
                                                    <div>
                                                        <span>Nom</span>
                                                    </div>
                                                </th>
                                                <th class="yui-dt-editable">
                                                    <div>
                                                        <span>Urgent</span>
                                                    </div>
                                                </th>
                                                <th class="yui-dt-editable">
                                                    <div>
                                                        <span>Demandée</span>
                                                    </div>
                                                </th>
                                                <th>
                                                    <div>
                                                        <span>Cote</span>
                                                    </div>
                                                </th>
                                                <th class="yui-dt-editable">
                                                    <div>
                                                        <span>Prix</span>
                                                    </div>
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody id="tbody_analysis" style=""></tbody>
                                    </table>
                                </div>
                                
                                <div class="clear"></div>
                                
                                <div class="form-group">
                                    <div class="statictext col-md-3 title"><span>Actes de prélèvement</span></div>
                                </div>
                                <div class="listing table-responsive yui-dt" id="listing_pb">
                                    <table id="table_sample">
                                        <colgroup>{% if entry == 'Y' %}<col>{% endif %}<col><col><col><col><col><col></colgroup>
                                        <thead>
                                            <tr>
                                                <th style="display:none;">
                                                    <div>
                                                        <span>id_data</span>
                                                    </div>
                                                </th>
                                                {% if entry == 'Y' %}
                                                <th>
                                                    <div>
                                                        <span>Action</span>
                                                    </div>
                                                </th>
                                                {% endif %}
                                                <th id="yui-dt17-th-code" rowspan="1" colspan="1" class="string yui-dt17-col-code yui-dt-col-code yui-dt-sortable">
                                                    <div id="yui-dt17-th-code-liner" class="yui-dt-liner">
                                                        <span><a href="yui-dt17-href-code" title="Click to sort ascending" class="yui-dt-sortable">Code</a></span>
                                                    </div>
                                                </th>
                                                <th id="yui-dt17-th-nom" rowspan="1" colspan="1" class="string yui-dt17-col-nom yui-dt-col-nom yui-dt-sortable">
                                                    <div id="yui-dt17-th-nom-liner" class="yui-dt-liner">
                                                        <span><a href="yui-dt17-href-nom" title="Click to sort ascending" class="yui-dt-sortable">Nom</a></span>
                                                    </div>
                                                </th>
                                                <th id="yui-dt17-th-demande" rowspan="1" colspan="1" class="fkey_dico yui-dt17-col-demande yui-dt-col-demande yui-dt-sortable yui-dt-editable">
                                                    <div id="yui-dt17-th-demande-liner" class="yui-dt-liner">
                                                        <span><a href="yui-dt17-href-demande" title="Click to sort ascending" class="yui-dt-sortable">Demandée</a></span>
                                                    </div>
                                                </th>
                                                <th id="yui-dt17-th-cote" rowspan="1" colspan="1" class="string yui-dt17-col-cote yui-dt-col-cote yui-dt-sortable">
                                                    <div id="yui-dt17-th-cote-liner" class="yui-dt-liner">
                                                        <span><a href="yui-dt17-href-cote" title="Click to sort ascending" class="yui-dt-sortable">Cote</a></span>
                                                    </div>
                                                </th>
                                                <th id="yui-dt17-th-prix" rowspan="1" colspan="1" class="float yui-dt17-col-prix yui-dt-col-prix yui-dt-sortable yui-dt-editable yui-dt-last">
                                                    <div id="yui-dt17-th-prix-liner" class="yui-dt-liner">
                                                        <span><a href="yui-dt17-href-prix" title="Click to sort ascending" class="yui-dt-sortable">Prix</a></span>
                                                    </div>
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody id="tbody_sample" class="yui-dt-message" style=""></tbody>
                                    </table>
                                </div>
                                
                                <div class="clear"></div>
                
                            </div>
                        </div>
                    </div>
                </div>

                <div id="facturation-group-group" class="panel panel-1 panel-primary" style="">
                    <div class="panel-heading"><h3 class="panel-title">Facturation</h3></div>
                    <div class="panel-body " id="facturation-group-group_body">
                        <div class="row">
                            <div id="facturation-group" class="col-xs-12">
                                <div class="form-group">
                                    <label class="control-label col-lg-3" style=""><span data-field="prix">{{ _('Prix total') }}</span></label>
                                    <div class="field col-md-3 col-lg-4">
                                        {% if entry == 'Y' %}
                                        <input type="text" id="bill_price" name="bill_price" value="" maxlength="16" class="form-control" style="width: 160px;" min="0" max="9999999999999" readonly="">
                                        {% else %}
                                        data_bill_price
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="control-label col-lg-3" style=""><span data-field="remise">{{ _('Remise sur la facturation') }}</span></label>
                                    <div class="field col-lg-2">
                                        {% if entry == 'Y' %}
                                        <select class="form-control">
                                            <option selected=""></option>
                                            {% for discount_type in ihm['discount_bill'] %}
                                            <option value="{{ discount_type['id_data'] }}">{{ _(discount_type['label']) }}</option>
                                            {% endfor %}
                                        </select>
                                        {% else %}
                                        data_discount_bill
                                        {% endif %}
                                    </div>
                                    <label class="control-label col-lg-2" style=""><span data-field="remise_pourcent">{{ _('Pourcentage de la remise') }}</span></label>
                                    <div class="field col-md-3 col-lg-4">
                                        {% if entry == 'Y' %}
                                        <input type="text" value="" maxlength="8" class="form-control" style="width: 96px;" min="0" max="99999">
                                        {% else %}
                                        data_remise
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="control-label col-lg-3" style="">
                                        <span data-field="assu_pourcent">{{ _('Pourcentage assurance maladie / mutuelle') }}</span>
                                    </label>
                                    <div class="field col-md-3 col-lg-4">
                                        {% if entry == 'Y' %}
                                        <input type="text" value="" maxlength="8" class="form-control" style="width: 96px;" min="0" max="99999">
                                        {% else %}
                                        data_assur_maladie
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="control-label col-lg-3" style=""><span data-field="a_payer">{{ _('Reste à payer') }}</span></label>
                                    <div class="field col-md-3 col-lg-4">
                                        {% if entry == 'Y' %}
                                        <input type="text" id="bill_remain" name="bill_remain" value="" maxlength="16" class="form-control" style="width: 160px;" min="0" max="9999999999999" readonly="">
                                        {% else %}
                                        data_reste_a_payer
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="control-label col-lg-3" style=""><span data-field="num_quittance">{{ _('Numéro de quittance') }}</span></label>
                                    <div class="field col-md-3 col-lg-4">
                                        {% if entry == 'Y' %}
                                        <input type="text" id="field_num_quitance" name="field_num_quitance" value="" maxlength="20" class="form-control" style="width: 200px;" null="">
                                        {% else %}
                                        data_quittance
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


                <div id="prel-group-group" class="panel panel-1 panel-primary" style="">
                    <div class="panel-heading"><h3 class="panel-title">Produits pathologiques</h3></div>
                    <div class="panel-body " id="prel-group-group_body">
                        <div class="row">
                            <div id="prel-group" class="col-xs-12">
                                {% if entry == 'Y' %}
                                <input type="button" onclick="new_prod();return false;" id="prod_new" class="btn btn-primary" value="{{ _('Ajouter un prélèvement') }}">
                                {% endif %}
                                <div class="listing table-responsive yui-dt" id="listing_prel">
                                    <div class="yui-dt-mask" style="display:none;"></div>
                                    <table id="table_product" summary="">
                                        <colgroup>{% if entry == 'Y' %}<col>{% endif %}<col><col><col><col><col><col><col><col></colgroup>
                                        <thead>
                                            <tr>
                                                <th style="display:none;">
                                                    <div>
                                                        <span>id_data</span>
                                                    </div>
                                                </th>
                                                {% if entry == 'Y' %}
                                                <th>
                                                    <div>
                                                        <span>Action</span>
                                                    </div>
                                                </th>
                                                {% endif %}
                                                <th id="yui-dt35-th-type_prel" rowspan="1" colspan="1" class="fkey_dico yui-dt35-col-type_prel yui-dt-col-type_prel yui-dt-sortable yui-dt-editable">
                                                    <div id="yui-dt35-th-type_prel-liner" class="yui-dt-liner">
                                                        <span>
                                                            <a href="yui-dt35-href-type_prel" title="Click to sort ascending" class="yui-dt-sortable">Prod. pathol.</a>
                                                        </span>
                                                    </div>
                                                </th>
                                                <th id="yui-dt35-th-statut" rowspan="1" colspan="1" class="fkey_dico yui-dt35-col-statut yui-dt-col-statut yui-dt-sortable yui-dt-editable">
                                                    <div id="yui-dt35-th-statut-liner" class="yui-dt-liner">
                                                        <span>
                                                            <a href="yui-dt35-href-statut" title="Click to sort ascending" class="yui-dt-sortable">Statut</a>
                                                        </span>
                                                    </div>
                                                </th>
                                                <th id="yui-dt35-th-date_prel" rowspan="1" colspan="1" class="date yui-dt35-col-date_prel yui-dt-col-date_prel yui-dt-sortable yui-dt-editable">
                                                    <div id="yui-dt35-th-date_prel-liner" class="yui-dt-liner">
                                                        <span><a href="yui-dt35-href-date_prel" title="Click to sort ascending" class="yui-dt-sortable">Date Prel</a>
                                                        </span>
                                                    </div>
                                                </th>
                                                <th id="yui-dt35-th-date_reception" rowspan="1" colspan="1" class="date yui-dt35-col-date_reception yui-dt-col-date_reception yui-dt-sortable yui-dt-editable">
                                                    <div id="yui-dt35-th-date_reception-liner" class="yui-dt-liner">
                                                        <span>
                                                            <a href="yui-dt35-href-date_reception" title="Click to sort ascending" class="yui-dt-sortable">Date réception</a>
                                                        </span>
                                                    </div>
                                                </th>
                                                <th id="yui-dt35-th-preleveur" rowspan="1" colspan="1" class="string yui-dt35-col-preleveur yui-dt-col-preleveur yui-dt-sortable yui-dt-editable">
                                                    <div id="yui-dt35-th-preleveur-liner" class="yui-dt-liner">
                                                        <span>
                                                            <a href="yui-dt35-href-preleveur" title="Click to sort ascending" class="yui-dt-sortable">Préleveur</a>
                                                        </span>
                                                    </div>
                                                </th>
                                                <th id="yui-dt35-th-quantite" rowspan="1" colspan="1" class="integer yui-dt35-col-quantite yui-dt-col-quantite yui-dt-sortable yui-dt-editable">
                                                    <div id="yui-dt35-th-quantite-liner" class="yui-dt-liner">
                                                        <span>
                                                            <a href="yui-dt35-href-quantite" title="Click to sort ascending" class="yui-dt-sortable">Qtté</a>
                                                        </span>
                                                    </div>
                                                </th>
                                                <th id="yui-dt35-th-commentaire" rowspan="1" colspan="1" class="string yui-dt35-col-commentaire yui-dt-col-commentaire yui-dt-sortable yui-dt-editable yui-dt-last">
                                                    <div id="yui-dt35-th-commentaire-liner" class="yui-dt-liner">
                                                        <span>
                                                            <a href="yui-dt35-href-commentaire" title="Click to sort ascending" class="yui-dt-sortable">Commentaire</a>
                                                        </span>
                                                    </div>
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody id="tbody_product" class="yui-dt-data"></tbody>
                                    </table>
                                </div>
                                <div class="clear"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="rc-group-group" class="panel panel-1 panel-primary" style="">
                    <div class="panel-heading"><h3 class="panel-title">{{ _('Renseignements / Informations complémentaires') }}</h3></div>
                    <div class="panel-body " id="rc-group-group_body">
                        <div class="row">
                            <div id="rc-group" class="col-xs-12">
                                <div class="field col-md-12">
                                    {% if entry == 'Y' %}
                                    <textarea rows="5" cols="80" class="form-control"></textarea>
                                    {% else %}
                                    data_comm
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group button" id="button">
                    {% if entry == 'Y' %}
                    <input type="button" onclick="save_requests();" id="save" class="btn btn-primary" value="{{ _('Enregistrer') }}">
                    {% else %}
                    <input type="button" onclick="valid_requests();" id="valid" class="btn btn-primary" value="{{ _('Valider') }}">
                    {% endif %}
                    <input type="button" onclick="return_home();" id="exit" class="btn undefined btn-default" value="{{ _('Quitter') }}">
                </div>

            </form><!-- close form_main -->
            
        </div>
    </div>
</div><!-- ferme le corps -->
{% endblock %}

{% block add_script %}
<script>
var struct_ana    = {"id_data":0 ,"code":"", "name":"", "emer":0, "ask":4, "rate":"", "price":0} ;
var struct_samp   = {"id_data":0 ,"code":"", "name":"", "ask":4, "rate":"", "price":0} ;
var struct_prod   = {"id_data":0 ,"type":0, "stat":0, "dateSamp":"", "dateReceiv":"", "sampler":"", "qty":0, "comm":""} ;
var data_analysis = {{ args['data_analysis']|safe }} ;
var data_samples  = {{ args['data_samples']|safe }}  ;
var data_products = {{ args['data_products']|safe }} ;
var ind_products  = 0  ;
var bill_price    = 0  ;
var bill_remain   = {{ args['billing_pat']['value'] }} ;
var act_price     = {{ ihm['act_price']['value'] }} ;
var opt_yorn      = {{ ihm['yorn']|safe }} ;

function change_pat( id_pat ) 
{
window.location.href = "{{ session['server_ext'] }}/{{ session['redirect_name'] }}/det-patient/" + id_pat ;
}

$("#search_doctor").select2(
{
    tokenSeparators: [' '],
    tags: false,
    minimumInputLength: 2,
    ajax: {
        url: "{{ session['server_ext'] }}/services/doctor/search/" + {{ session['user_id_group'] }},
        type: "POST",
        dataType: "json",
        contentType: "application/json; charset=utf-8",
        term: $("#search_doctor").text(),
        data: function (params) {

            return JSON.stringify({
                term: params.term
            });
        },
        processResults: function (data) {
            return {
                results: $.map(data, function (item) {
                    return {
                        text: item.field_value,
                        id: item.id_doctor
                    }
                })
            };
        }
    }
} ) ;

$("#search_analysis").select2(
{
    tokenSeparators: [',', ' '],
    minimumInputLength: 2,
    ajax: {
        url: "{{ session['server_ext'] }}/services/analysis/search/" + {{ session['user_id_group'] }},
        type: "POST",
        dataType: "json",
        contentType: "application/json; charset=utf-8",
        term: $("#search_analysis").text(),
        data: function (params) {
            return JSON.stringify(
            {
                term: params.term
            } ) ;
        },
        processResults: function (data) {
            return {
                // data need id key if not no focus selection displayed
                results: data
            } ;
        }
    },
    templateResult: formatRepoAnalysis
} ) ;

function formatRepoAnalysis(repo)
{
    if (repo.loading)
    return repo.text ;

var code = "" ;

    if (repo.code)
    code += "[" + repo.code + "]" ;

var name = "" ;

    if (repo.name)
    name += repo.name ;

var cat = "" ;

    if (repo.label)
    cat += repo.label ;

var display = $(
    "<div class='select2-result-repository clearfix'>" +
        "<div class='select2-result-repository__meta'>" +
            "<div class='select2-result-repository__code'><b>" + code + "</b></div>" +
            "<div class='select2-result-repository__name'>" + name + "</div>" +
            "<div class='select2-result-repository__category'>" + cat + "</div>" +
        "</div>" +
    "</div>") ;

return display ;
}

$("#search_analysis").on("select2:select", function (e) 
{
let id_item    = $(e.currentTarget).val();
let data_exist = false ;

    // check if this analysis is not already used
    if ( !$.isEmptyObject(data_analysis) )
    $.map(data_analysis,function(val,key) { if(val.id_data == id_item) { data_exist = true; } } ) ;

    if (!data_exist)
    {
        $("#search_analysis").empty() ;

        // GET det analysis
        $.ajax( {
            type: "GET",
            url: "/services/analysis/det/" + id_item,
            success: function(data_ana)
                {
                console.log("DEBUG /services/analysis/det/"+id_item+" = " +JSON.stringify(data_ana) ) ;

                let tmp_struct_ana = JSON.parse(JSON.stringify(struct_ana)) ; // copy structure

                tmp_struct_ana.id_data = data_ana.id_data ;
                tmp_struct_ana.code    = data_ana.code ;
                tmp_struct_ana.name    = data_ana.nom ;
                tmp_struct_ana.rate    = data_ana.cote_unite + data_ana.cote_valeur ;
                tmp_struct_ana.price   = act_price * data_ana.cote_valeur ;

                data_analysis.push(tmp_struct_ana) ;

                // load new analysis in table
                load_analysis( tmp_struct_ana ) ;
                refresh_bill() ;

                console.log( "DEBUG data_ana.produit_biologique =" + data_ana.produit_biologique ) ;

                    // id_samp greater than 0 then GET det sample linked to analysis
                    if ( data_ana.produit_biologique > 0 )
                    {
                    let id_type_prod = data_ana.type_prel ;

                    // check if this analysis is not already used
                    if (!$.isEmptyObject(data_samples) )
                    $.map(data_samples,function(val,key) { if ( val.id_data == data_ana.produit_biologique ) { data_exist = true; } } ) ;

                        if (!data_exist)
                        {
                            // GET det sample
                            $.ajax( {
                                type: "GET",
                                url: "/services/analysis/det/" +  data_ana.produit_biologique,
                                success: function(data_samp)
                                    {
                                    let tmp_struct_samp = JSON.parse(JSON.stringify(struct_samp)) ;

                                    tmp_struct_samp.id_data = data_samp.id_data ;
                                    tmp_struct_samp.code    = data_samp.code ;
                                    tmp_struct_samp.name    = data_samp.nom ;
                                    tmp_struct_samp.rate    = data_samp.cote_unite + data_samp.cote_valeur ;
                                    tmp_struct_samp.price   = act_price * data_samp.cote_valeur ;

                                    data_samples.push(tmp_struct_samp) ;

                                    // load new sample in table
                                    load_sample( tmp_struct_samp ) ;
                                    refresh_bill() ;

                                    console.log("DEBUG /services/analysis/det/"+data_ana.produit_biologique+" = " +JSON.stringify(data_samp) ) ;
                                    },
                                error: function(data_samp)
                                    {
                                    console.log("ERROR GET det sample");
                                    // TODO display error
                                    }
                            } ) ;

                            // GET type product
                            $.ajax( {
                                type: "GET",
                                url: "/services/analysis/type/product/" +  id_type_prod,
                                success: function(data_prod)
                                    {
                                    let tmp_struct_prod = JSON.parse(JSON.stringify(struct_prod)) ;

                                    tmp_struct_prod.id_data    = ind_products++ ;
                                    tmp_struct_prod.type       = data_prod.id_data ;
                                    tmp_struct_prod.stat       = 9 ; // TODO where get data ?

                                    data_products.push(tmp_struct_prod) ;

                                    // load new product in table
                                    load_product( tmp_struct_prod ) ;

                                    console.log("DEBUG /services/analysis/type/product/"+id_type_prod+" = " +JSON.stringify(data_prod) ) ;
                                    },
                                error: function(data_prod)
                                    {
                                    console.log("ERROR GET type product");
                                    // TODO display error
                                    }
                            } ) ;
                        }
                    }
                },
            error: function(data_ana)
                {
                console.log("ERROR GET det analysis");
                // TODO display error
                }
        } ) ;
    }

// tmp_search = $.map(tmp_data,function(val,key) { if(val.id_data == id_item) { return val ; } } ) ;
} ) ;

function load_analysis( data )
{
let tr_analysis = '' ;

    if (data.length < 1)
    {
    tr_analysis = '' ; //'<tr class=""><td colspan="8">' +
                  //'<div>Aucune donnée à afficher</div></td></tr>' ;
    }
    else
    {
    let obj    = data ;
    let tmp_tr = '<tr style="">' ;

    {% if entry == 'Y' %}
    let btn = '<input type="button" onclick="del_analysis(' + obj.id_data + ');load_data();refresh_bill();" value="' + '{{ _("Supprimer") }}' + '">' ;

    tmp_tr += create_td(obj.id_data, obj.id_data, "", "display:none;") ;
    tmp_tr += create_td("", btn, "", "") ;
    tmp_tr += create_td("", obj.code, "", "") ;
    tmp_tr += create_td("", obj.name, "", "") ;
    tmp_tr += create_td("", create_select("ana_emer_"+obj.id_data, opt_yorn, obj.emer, true), "", "") ;
    tmp_tr += create_td("", create_select("ana_ask_"+obj.id_data, opt_yorn, obj.ask, false), "", "") ;
    tmp_tr += create_td("", format_rate(obj.rate, obj.price), "", "") ;
    tmp_tr += create_td("", create_input("ana_price_"+obj.id_data, "number", obj.price, 0, 999999), "", "") ;
    {% else %}
    tmp_tr += create_td(obj.id_data, obj.id_data, "", "display:none;") ;
    tmp_tr += create_td("", obj.code, "", "") ;
    tmp_tr += create_td("", obj.name, "", "") ;
    tmp_tr += create_td("", obj.emer, "", "") ;
    tmp_tr += create_td("", obj.ask, "", "") ;
    tmp_tr += create_td("", format_rate(obj.rate, obj.price), "", "") ;
    tmp_tr += create_td("", obj.price, "", "") ;
    {% endif %}

    tmp_tr += '</tr>' ;

    bill_price  += obj.price ;
    bill_remain += obj.price ;

    tr_analysis += tmp_tr ;
    }

console.log( "DEBUG tr_analysis = " + tr_analysis ) ;

$("#tbody_analysis").append(tr_analysis) ;
$("#table_analysis").tablesorter() ;
}

function del_analysis( id_data )
{
    for( i in data_analysis )
    {
        if (data_analysis[i].id_data == id_data)
        {
        bill_price  -= data_analysis[i].price ;
        bill_remain -= data_analysis[i].price ;

        delete data_analysis[i] ;

        break ;
        }
    }
}

function load_sample( data )
{
let tr_sample = '' ;

    if (data.length < 1)
    {
    tr_sample = '' ; //'<tr class=""><td colspan="7">' +
                  //'<div>Aucune donnée à afficher</div></td></tr>' ;
    }
    else
    {
    let obj = data ;

        if ( obj.id_data > 0 )
        {
        let tmp_tr = '<tr style="">' ;

        {% if entry == 'Y' %}
        let btn = '<input type="button" onclick="del_sample(' + obj.id_data + ');load_data();refresh_bill();" value="' + '{{ _("Supprimer") }}' + '">' 

        tmp_tr += create_td(obj.id_data, obj.id_data, "", "display:none;") ;
        tmp_tr += create_td("", btn, "", "") ;
        tmp_tr += create_td("", obj.code, "", "") ;
        tmp_tr += create_td("", obj.name, "", "") ;
        tmp_tr += create_td("", create_select("samp_ask_"+obj.id_data, opt_yorn, obj.ask, false), "", "") ;
        tmp_tr += create_td("", format_rate(obj.rate, obj.price), "", "") ;
        tmp_tr += create_td("", create_input("samp_price_"+obj.id_data, "number", obj.price, 0, 999999), "", "") ;
        {% else %}
        tmp_tr += create_td(obj.id_data, obj.id_data, "", "display:none;") ;
        tmp_tr += create_td("", obj.code, "", "") ;
        tmp_tr += create_td("", obj.name, "", "") ;
        tmp_tr += create_td("", obj.ask, "", "") ;
        tmp_tr += create_td("", format_rate(obj.rate, obj.price), "", "") ;
        tmp_tr += create_td("", obj.price, "", "") ;
        {% endif %}

        tmp_tr += '</tr>' ;

        bill_price  += obj.price ;
        bill_remain += obj.price ;

        tr_sample += tmp_tr ;
        }
    }

console.log( "DEBUG tr_sample = " + tr_sample ) ;

$("#tbody_sample").append(tr_sample) ;
$("#table_sample").tablesorter() ;
}

function del_sample( id_data )
{
    for( i in data_samples )
    {
        if (data_samples[i].id_data == id_data)
        {
        bill_price  -= data_samples[i].price ;
        bill_remain -= data_samples[i].price ;

        delete data_samples[i] ;

        break ;
        }
    }
}

function load_product( data )
{
let tr_product = '' ;

    if (data.length < 1)
    {
    tr_product = '' ; //'<tr class=""><td colspan="7">' +
                  //'<div>Aucune donnée à afficher</div></td></tr>' ;
    }
    else
    {
    let obj = data ;

        if ( obj.id_data >= 0 )
        {
        let tmp_tr = '<tr style="">' ;

        {% if entry == 'Y' %}
        let btn = '<input type="button" onclick="del_product(' + obj.id_data + ');load_data();" value="' + '{{ _("Supprimer") }}' + '">' ;

        tmp_tr += create_td(obj.id_data, obj.id_data, "", "display:none;") ;
        tmp_tr += create_td("", btn, "", "") ; // actions
        tmp_tr += create_td("", create_select("prod_type_"+obj.id_data, {{ ihm['products']|safe }}, obj.type, true), "", "") ; // select product
        tmp_tr += create_td("", create_select("prod_stat_"+obj.id_data, {{ ihm['products_statut']|safe }}, obj.stat, true), "", "") ; // select statut
        tmp_tr += create_td("", create_input("prod_dateSamp_"+obj.id_data, "date", obj.dateSamp, 0, 0), "", "") ; // input date prel
        tmp_tr += create_td("", create_input("prod_dateReceiv_"+obj.id_data, "date", obj.dateReceiv, 0, 0), "", "") ; // input date recept
        tmp_tr += create_td("", create_input("prod_sampler_"+obj.id_data, "text", obj.sampler, 0, 0), "", "") ; // input text preleveur
        tmp_tr += create_td("", create_input("prod_qty_"+obj.id_data, "number", obj.qty, 0, 10), "", "") ; // input number qtte
        tmp_tr += create_td("", create_input("prod_comm_"+obj.id_data, "text", obj.comm, 0, 0), "", "") ; // input text comm
        {% else %}
        tmp_tr += create_td(obj.id_data, obj.id_data, "", "display:none;") ;
        tmp_tr += create_td("", obj.type, "", "") ;
        tmp_tr += create_td("", obj.stat, "", "") ;
        tmp_tr += create_td("", obj.dateSamp, "", "") ;
        tmp_tr += create_td("", obj.dateReceiv, "", "") ;
        tmp_tr += create_td("", obj.qty, "", "") ;
        tmp_tr += create_td("", obj.comm, "", "") ;
        {% endif %}

        tmp_tr += '</tr>' ;

        tr_product += tmp_tr ;
        }
    }

console.log( "DEBUG tr_product = " + tr_product ) ;

$("#tbody_product").append(tr_product) ;
$("#table_product").tablesorter() ;
}

function del_product( id_data )
{
    for( i in data_products )
    {
        if (data_products[i].id_data == id_data)
        {
        delete data_products[i] ;

        break ;
        }
    }
}

function create_td(id, val, cls, style)
{
let tmp_td = '<td class="' + cls + '" id="' + id + '" style="' + style + '">' +
             '<div>' + val + '</div></td>' ;

return tmp_td ;
}

function create_select(id, l_options, val_select, opt_empty)
{
let tmp_select = '<select class="form-control" id="' + id + '" onChange="change_data(this)">' ;

    if (opt_empty)
    tmp_select += '<option value="0"></option>' ;

    for( i in l_options )
    {
    let selected = "" ;

        if (l_options[i].id_data == val_select)
        selected = "selected" ;

    tmp_select += '<option value="' + l_options[i].id_data + '" ' + selected + ' >' + l_options[i].label + '</option>' ;
    }

tmp_select += '</select>' ;

return tmp_select ;
}

function create_input(id, type, val, min, max)
{
let tmp_input = '<input class="form-control" id="' + id + '" type="' + type + '" value="' + val + '" onChange="change_data(this)"' ;

    if (type == "number")
    tmp_input += 'min="' + min + '" max="' + max + '" style="max-width:75px;text-align:right;"' ;

tmp_input += '>' ;

return tmp_input ;
}

function change_data( elem )
{
// Get new value from select or input
let val = $(elem).val() ;

// Change value in data structure
let id_elem = elem.id ;
console.log("DEBUG change_data id_elem=" + id_elem) ;
let split_id = id_elem.split("_") ;
let id_data  = split_id[split_id.length -1] ; 

    if ( split_id[0] == "ana" )
    {
        for( i in data_analysis )
        {
            if (data_analysis[i].id_data == id_data )
            {
                if ( split_id[1] == "emer" )
                data_analysis[i].emer = val ;
                else if ( split_id[1] == "ask" )
                data_analysis[i].ask = val ;
                else if ( split_id[1] == "price" )
                data_analysis[i].price = val ;

            break ;
            }
        }
    }
    else if ( split_id[0] == "samp" )
    {
        for( i in data_samples )
        {
            if (data_samples[i].id_data == id_data )
            {
                if ( split_id[1] == "ask" )
                data_samples[i].ask = val ;
                else if ( split_id[1] == "price" )
                data_samples[i].price = val ;

            break ;
            }
        }
    }
    else if ( split_id[0] == "prod" )
    {
        for( i in data_products )
        {
            if (data_products[i].id_data == id_data )
            {
                if ( split_id[1] == "type" )
                data_products[i].type = val ;
                else if ( split_id[1] == "stat" )
                data_products[i].stat = val ;
                else if ( split_id[1] == "dateSamp" )
                data_products[i].dateSamp = val ;
                else if ( split_id[1] == "dateReceiv" )
                data_products[i].dateReceiv = val ;
                else if ( split_id[1] == "sampler" )
                data_products[i].sampler = val ;
                else if ( split_id[1] == "qty" )
                data_products[i].qty = val ;
                else if ( split_id[1] == "comm" )
                data_products[i].comm = val ;

            break ;
            }
        }
    }
}

function format_rate(rate, price)
{
return rate + '(' + price + ')' ;
}

function refresh_bill()
{
$("#bill_price").val(bill_price)   ;
$("#bill_remain").val(bill_remain) ;
}

function new_prod()
{
let tmp_struct_prod = JSON.parse(JSON.stringify(struct_prod)) ;

tmp_struct_prod.id_data = ind_products++ ;

data_products.push(tmp_struct_prod) ;

load_product( tmp_struct_prod ) ;
}

function load_data()
{
console.log("DEBUG load_data()") ;

// clear table tbody
$("#tbody_analysis").empty() ;
$("#tbody_sample").empty() ;
$("#tbody_product").empty() ;

    for( i in data_analysis )
    {
    load_analysis( data_analysis[i] ) ;
    }

    for( i in data_samples )
    {
    load_sample( data_samples[i] ) ;
    }

    for( i in data_products )
    {
    load_product( data_products[i] ) ;
    }
}

$("input[type=radio][name=colis]").change(function() 
{
    if (this.value == '4') 
    {
    $("#parcel_id").val("")   ;
    $("#parcel_date").val("") ;
    $("#colis-group").show()  ;
    }
    else if (this.value == '5') 
    {
    // hide identification and date reception
    $("#parcel_id").val("")   ;
    $("#parcel_date").val("") ;
    $("#colis-group").hide()  ;
    }
} ) ;

function save_requests()
{
let data_save = {{ args|safe }} ;

// TODO ajouter a data_save 
data_save.data_analysis = data_analysis ;
data_save.data_samples  = data_samples  ;
data_save.data_products = data_products ;

    $.ajax(
    {
        type : 'POST',
        url : "{{ session['server_ext'] }}/{{ session['redirect_name'] }}/save-data/",
        dataType: "json",
        contentType: "application/json; charset=utf-8",
        data : JSON.stringify(data_save),
        success : function(response)
        {
        window.location.href = "{{ session['server_ext'] }}/{{ session['redirect_name'] }}/det-req-ext/N/" + {{ args['id_data'] }} ;
        }
    } ) ;
}

function valid_requests()
{
let data_save = {{ args|safe }} ;

// TODO ajouter a data_save 
data_save.data_analysis = data_analysis ;
data_save.data_samples  = data_samples  ;
data_save.data_products = data_products ;

    $.ajax(
    {
        type : 'POST',
        url : "{{ session['server_ext'] }}/{{ session['redirect_name'] }}/save-data/",
        dataType: "json",
        contentType: "application/json; charset=utf-8",
        data : JSON.stringify(data_save),
        success : function(response)
        {
        window.location.href = "{{ session['server_ext'] }}/{{ session['redirect_name'] }}/administrative-record/N/" + {{ args['id_data'] }} ;
        }
    } ) ;
}

function return_home()
{
window.location.href = "{{ session['server_ext'] }}/sigl/";
}

$( document ).ready( function()
{
    $("#date_record").val( "{{ now|date_now }}" ) ;
    load_data() ;

    console.log("DEBUG ready data_analysis="+JSON.stringify(data_analysis));
} ) ;
</script>
{% endblock %}

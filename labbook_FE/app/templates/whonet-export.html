{% extends "skeleton.html" %}

{% block head %}
{{ super() }}
<title>{{ _("Export WHONET") }}</title>
{% endblock %}

{% block content %}
<div id="content">
    <div class="inner">
        <div id="main" style="opacity: 1;">
            <h2 class="page-title"><span>{{ _("Export WHONET") }}</span></h2>
            <form id="form_main" enctype="application/x-www-form-urlencoded" method="post" class="vzn-form form-horizontal row" action="">
                <fieldset id="filter-group" class="group group-1">
                    <div class="row">
                        <div id="filter" class="col-xs-12">
                            <div class="form-group">
                                <span>{{ _("Date de validation du ") }}</span>
                                <div class="field date-fields form-inline">
                                    <input id="date_beg" class="form-control" type="date" maxlength="10" size="10" value="" name="date_beg" style="color: #888;">
                                </div>
                                <span> au </span>
                                <div class="field date-fields form-inline">
                                    <input id="date_end" class="form-control" type="date" maxlength="10" size="10" value="" name="date_end" style="color: #888;">
                                </div>
                            </div>
                            <br />
                            <div class="form-group button">
                                <input type="button" onclick="export_whonet();" class="btn undefined btn-default" value="{{ _("Récupérer les données") }}">
                            </div>
                        </div>
                    </div>
                </fieldset>
            </form>
            <!-- Popup waiting -->
            <div class="modal fade" id="dial_wait" role="dialog" tabindex="-1" aria-labelledby="myModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dlg-cancel" style="background:#EEE;">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">x</button>
                        <h4>{{ _("Processus en cours") }}</h4>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <span data-field="reason">{{ _("Veuillez patienter") }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div><!-- close main -->
    </div><!-- close inner -->
</div><!-- close body -->
{% endblock %}

{% block add_script %}
<script>

function download_file( type, filename, ref )
{
// TODO check user role rights ?
window.location = "{{ session['server_ext'] }}/{{ session['redirect_name'] }}/download-file/type/" + type + "/name/" + filename + "/ref/" + ref ;
}

function export_whonet()
{
var date_beg = $("#date_beg").val() ;
var date_end = $("#date_end").val() ;
var param    = '{"date_beg":"' + date_beg + '", "date_end":"' + date_end + '"}' ;

    // popup wait
    $( "#dial_wait" ).modal( "show" ) ;

    $.ajax( 
    {
        type: "POST",
        url: "{{ session['server_ext'] }}/services/export/whonet",
        dataType: 'json',
        contentType: "application/json; charset=utf-8",
        data: param,
        success: function(ret)
        {
            $( "#dial_wait" ).modal( "hide" ) ;

        download_file( "PY", "whonet_" + date_beg + "_" + date_end + ".txt", 0 ) ;
        },
        error: function(ret)
        {
            $( "#dial_wait" ).modal( "hide" ) ;

        if (ret.status == 404)
            alert("{{ _("Aucun résultats à exporter !") }}") ;
        else
            alert("{{ _("Erreur lors de la génération du csv WHONET") }}") ;
        }
    } ) ;
}

$( document ).ready( function()
{
let year = new Date().getFullYear() ;

let date_beg = year + "-01-01" ;

    $("#date_beg").val( date_beg ) ;
    $("#date_end").val( "{{ now|date_now }}" ) ;
} ) ;
</script>
{% endblock %}

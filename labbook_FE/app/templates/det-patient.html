{% extends "skeleton.html" %}

{% block head %}
{{ super() }}
    <title>{{ _("Détails patient") }}</title>
    <link href="{{ url_for('static', filename='vendor/css/bootstrap-datepicker3.min.css') }}" rel="stylesheet" />
{% endblock %}

{% block content %}
<div id="content">
    <div class="inner">
        <div id="main" style="opacity: 1;">
            <h2 class="page-title page-title-{{ session['user_role']|safe }}">
                <span>{{ _("Demande d'analyses patient - Fiche patient") }}</span>
            </h2>
            <form autocomplete="off">
                <div class="panel-heading row">
                    <h3 class="panel-title">{{ _("Identité") }}</h3>
                </div>
                <div class="row mt-3">
                    <div class="col">
                        <div class="form-group row">
                            <label class="col-form-label text-right mx-3">{{ _("Anonyme") }}</label>
                            <label class="col-form-label text-right mr-3">
                                <input type="radio" name="anonyme" value="4" {% if args['anonyme'] == 4 %} checked="checked" {% endif %}>&nbsp;{{ _("Oui") }}</input>
                            </label>
                            <label class="col-form-label text-right mr-3">
                                <input type="radio" name="anonyme" value="5" {% if not args['anonyme'] or args['anonyme'] == 5 %} checked="checked" {% endif %}>&nbsp;{{ _("Non") }}</input>
                            </label>
                        </div>
                    </div>
                    <div class="col-7">
                        <div class="form-group row">
                            <label for="code_patient" class="col-form-label col-5 text-right" style="">{{ _("Code patient interne au laboratoire") }}</label>
                            <div>
                                <input id="code_patient" type="text" value="{{ args['code_patient'] }}" maxlength="8" class="form-control" style="width:100px;">
                            </div>
                        </div>
                    </div>
                    <div class="col">
                        <div class="form-group row">
                            <div class="pat-num" id="anon-code-ro">
                                <span id="code">{{ args['code'] }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-5">
                        <div class="form-group row identity-group">
                            <label for="nom" class="col-form-label col-4 text-right" style="">{{ _("Nom") }}</label>
                            <div>
                                <input id="nom" type="text" value="{{ args['nom'] }}" maxlength="40" class="form-control" style="">
                            </div>
                        </div>
                    </div>
                    <div class="col-5">
                        <div class="form-group row">
                            <label for="ddn" class="col-form-label text-right mr-1">{{ _("Date de naissance") }}</label>
                            <div>
                                <input id="ddn" class="form-control" type="date" maxlength="10" size="10" value="{{ args['ddn'] }}" placeholder="" style="color: #888;">
                                <input id="date_current" type="hidden" maxlength="10" size="10" value="" name="date_current" >
                            </div>
                        </div>
                    </div>
                    <div class="col-5">
                        <div class="form-group row identity-group">
                            <label for="nom_jf" class="col-form-label col-4 text-right" style="">{{ _("Nom de jeune fille") }}</label>
                            <div>
                                <input id="nom_jf" type="text" value="{{ args['nom_jf'] }}" maxlength="40" class="form-control" style="">
                            </div>
                        </div>
                    </div>
                    <div class="col-5">
                        <div class="form-group row">
                            <label class="col-form-label text-right mr-3">{{ _("Date de naissance approximative") }}</label>
                            <label class="col-form-label text-right mr-3">
                                <input type="radio" name="ddn_approx" value="4" {% if args['ddn_approx'] == 4 %} checked="checked" {% endif %}>&nbsp;{{ _("Oui") }}</input>
                            </label>
                            <label class="col-form-label text-right mr-3">
                                <input type="radio" name="ddn_approx" value="5" {% if not args['ddn_approx'] or args['ddn_approx'] == 5 %} checked="checked" {% endif %}>&nbsp;{{ _("Non") }}</input>
                            </label>
                        </div>
                    </div>
                    <div class="col-5">
                        <div class="form-group row identity-group">
                            <label for="prenom" class="col-form-label col-4 text-right" style="">{{ _("Prénom(s)") }}</label>
                            <div>
                                <input id="prenom" type="text" value="{{ args['prenom'] }}" maxlength="80" class="form-control" style="">
                            </div>
                        </div>
                    </div>
                    <div class="col-5">
                        <div class="form-group row">
                            <span class="col-form-label text-center" style="">{{ _("ou") }}</span>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-5">
                        <div class="form-group row identity-group">
                            <label class="col-form-label text-right mx-3">{{ _("Sexe") }}</label>
                            <label class="col-form-label text-right mr-3">
                                <input type="radio" name="sexe" value="1" {% if args['sexe'] == 1 %} checked="checked" {% endif %}>&nbsp;{{ _("Masculin") }}</input>
                            </label>
                            <label class="col-form-label text-right mr-3">
                                <input type="radio" name="sexe" value="2" {% if args['sexe'] == 2 %} checked="checked" {% endif %}>&nbsp;{{ _("Féminin") }}</input>
                            </label>
                            <label class="col-form-label text-right mr-3">
                                <input type="radio" name="sexe" id="unknown_sex" value="3" {% if not args['sexe'] or args['sexe'] == 3 %} checked="checked" {% endif %}>&nbsp;{{ _("Inconnu") }}</input>
                            </label>
                        </div>
                    </div>
                    <div class="col-2">
                        <div class="form-group row">
                            <label for="age" class="col-form-label text-right mr-1">{{ _("Age") }}</label>
                            <div>
                                <input name="age" id="age" type="text" value="{% if args %}{{ args['age'] }}{% else %}0{% endif %}" maxlength="3" class="form-control" style="width:60px;" min="0" max="150">
                            </div>
                        </div>
                    </div>
                    <div class="col">
                        <div class="form-group row">
                            <label for="unite" class="col-form-label text-right mr-1">{{ _("unité") }}</label>
                            <div>					
                                <select name="unite" id="unite" class="form-control">
                                    <option value="1034" {% if args['unite'] == 1034 %} selected {% endif %}>{{ _("Jours") }}</option>
                                    <option value="1035" {% if args['unite'] == 1035 %} selected {% endif %}>{{ _("Semaines") }}</option>
                                    <option value="1036" {% if args['unite'] == 1036 %} selected {% endif %}>{{ _("Mois") }}</option>
                                    <option value="1037" {% if not args or args['unite'] == 1037 %} selected {% endif %}>{{ _("Années") }}</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="panel-heading row">
                    <h3 class="panel-title">{{ _("Coordonnées") }}</h3>
                </div>
                <div class="row mt-3">
                    <div class="col">
                        <div class="form-group row">
                            <label for="adresse" class="col-form-label col-3 text-right mr-1">{{ _("Adresse") }}</label>
                            <div>
                                <textarea id="adresse" rows="4" cols="50" class="form-control">{{ args['adresse'] }}</textarea>
                            </div>
                        </div>
                        <div class="form-group row">
                            <label for="tel" class="col-form-label col-3 text-right mr-1">{{ _("Téléphone") }}</label>
                            <div>
                                <input id="tel" type="text" value="{{ args['tel'] }}" maxlength="20" class="form-control" style="">
                            </div>
                        </div>
                        <div class="form-group row">
                            <label for="profession" class="col-form-label col-3 text-right mr-1">{{ _("Profession") }}</label>
                            <div>
                                <input id="profession" type="text" value="{{ args['profession'] }}" maxlength="50" class="form-control" style="">
                            </div>
                        </div>
                    </div>
                    <div class="col">
                        <div class="form-group row">
                            <label for="bp" class="col-form-label col-3 text-right mr-1">{{ _("Boite postale") }}</label>
                            <div>
                                <input id="bp" type="text" value="{{ args['bp'] }}" maxlength="10" class="form-control" style="">
                            </div>
                        </div>
                        <div class="form-group row">
                            <label for="quartier" class="col-form-label col-3 text-right mr-1">{{ _("Quartier / Secteur") }}</label>
                            <div>
                                <input id="quartier" type="text" value="{{ args['quartier'] }}" maxlength="40" class="form-control" style="">
                            </div>
                        </div>
                        <div class="form-group row">
                            <label for="cp" class="col-form-label col-3 text-right mr-1">{{ _("Code postal") }}</label>
                            <div>
                                <input id="cp" type="text" value="{{ args['cp'] }}" maxlength="10" class="form-control" style="">
                            </div>
                        </div>
                        <div class="form-group row">
                            <label for="ville" class="col-form-label col-3 text-right mr-1">{{ _("Ville / Village") }}</label>
                            <div>
                                <input id="ville" type="text" value="{{ args['ville'] }}" maxlength="40" class="form-control" style="">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="clearfix row mb-4">
                    <div class="col-12">
                        <div class="float-left" style="margin-left:0px;">
                            <input type="button" onclick="return_back();" class="btn btn-{{ session['user_role']|safe }}" value="{{ _("Retour") }}">
                        </div>
                        <div class="float-right mr-2">
                            <input type="button" onclick="save_pat( {{ args['id_pat'] }} );" class="btn btn-{{ session['user_role']|safe }}" value="{{ _("Enregistrer") }}"> 
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div><!-- close content -->
{% endblock %}

{% block add_script %}
<script>
function save_pat( id_pat ) 
{
var id_owner      = {{ session['user_id_group']|safe}} ;
var anonyme       = $("input:radio[name=anonyme]:checked").val() ;
var code          = $("#code").text() ;
var code_patient  = $("#code_patient").val() ;
var nom           = $("#nom").val() ;
var prenom        = $("#prenom").val() ;
var ddn           = $("#ddn").val() ;
var sexe          = $("input:radio[name=sexe]:checked").val() ;
var ethnie        = '' ; // useless
var adresse       = JSON.stringify( $("#adresse").val() ) ;
var cp            = $("#cp").val() ;
var ville         = $("#ville").val() ;
var tel           = $("#tel").val() ;
var profession    = $("#profession").val() ;
var nom_jf        = $("#nom_jf").val() ;
var quartier      = $("#quartier").val() ;
var bp            = $("#bp").val() ;
var ddn_approx    = $("input:radio[name=ddn_approx]:checked").val() ;
var age           = $("#age").val() ;
var annee_naiss   = 0 ; // useless
var semaine_naiss = 0 ; // useless
var mois_naiss    = 0 ; // useless
var unite         = $("#unite").val() ;

    // date de naissance obligatoire
    if (ddn == "" && age == "")
    {
    alert("{{ _("Veuillez sélectionner une date de naissance ou saisir un age") }}") ;
    return false;
    }
 
var param = '{ "id_owner":' + id_owner + ', ' +
              '"anonyme":' + anonyme  + ', ' +
              '"code":"' + code + '", ' +
              '"code_patient":"' + code_patient + '", ' +
              '"nom":"' + nom + '", ' +
              '"prenom":"' + prenom + '", ' +
              '"ddn":"' + ddn + '", ' +
              '"sexe":' + sexe + ', ' +
              '"ethnie":"' + ethnie + '", ' +
              '"adresse":' + adresse + ', ' + // NO QUOTE DUE TO STRINGIFY PROCESS
              '"cp":"' + cp + '", ' +
              '"ville":"' + ville + '", ' +
              '"tel":"' + tel + '", ' +
              '"profession":"' + profession + '", ' +
              '"nom_jf":"' + nom_jf + '", ' +
              '"quartier":"' + quartier + '", ' +
              '"bp":"' + bp + '", ' +
              '"ddn_approx":' + ddn_approx + ', ' +
              '"age":' + age + ', ' +
              '"annee_naiss":' + annee_naiss + ', ' +
              '"semaine_naiss":' + semaine_naiss + ', ' +
              '"mois_naiss":' + mois_naiss + ', ' +
              '"unite":' + unite + '}' ;

    // popup wait
    $("#dial-wait").modal("show") ;

    $("#dial-wait").off() ;

    $("#dial-wait").on('shown.bs.modal', function () 
    {
        $.ajax( 
        {
            type: "POST",
            url: "/services/patient/det/" + id_pat,
            dataType: 'json',
            contentType: "application/json; charset=utf-8",
            data: param,
            success: function(data)
            {
                $("#dial-wait").modal("hide") ;

            id_pat = data.id_pat ;

            {% if type_req == 'E' %}
            window.location.href = "{{ session['server_ext'] }}/{{ session['redirect_name'] }}/det-req-ext/Y/" + id_pat ;
            {% else %}
            window.location.href = "{{ session['server_ext'] }}/{{ session['redirect_name'] }}/det-req-int/Y/" + id_pat ;
            {% endif %}
            },
            error: function(data)
            {
                $("#dial-wait").modal("hide") ;

            console.log("ERROR POST patient det") ;
            alert("{{ _("Une erreur est survenue lors de la modification/ajout d'un patient") }}") ;
            }
        } ) ;
    } ) ;
}

$("input[type=radio][name=anonyme]").change(function() 
{
    if (this.value == '4') 
    {
    // Clean and hide input nom, prenom, nom_jf, sexe
    $("#nom").val("")    ;
    $("#nom_jf").val("") ;
    $("#prenom").val("") ;
    $("#unknown_sex").prop('checked', true) ;
    $(".identity-group").hide() ;
    }
    else if (this.value == '5') 
    {
    // Show input nom, prenom, nom_jf, sexe
    $(".identity-group").show() ;
    $("#unknown_sex").prop('checked', true) ;
    }
} ) ;

$("#ddn").change(function() 
{
// after date change calculate age and put unit
var start = $("#ddn").val() ;
var end   = $("#date_current").val() ;

// end - start returns difference in milliseconds 
var diff = new Date(Date.parse(end) - Date.parse(start));

var age = Math.abs(diff.getUTCFullYear() - 1970);

    if ( age >= 1 )
    {
        $("#age").val( age ) ;
        $("#unite").val("1037") ;
    }
    else
    {
    var days = diff/1000/60/60/24;

        if (days >= 28)
        {
        $("#age").val( (days / 30).toFixed(0) ) ;
        $("#unite").val("1036") ;
        }
        else
        {
        $("#age").val( (days).toFixed(0) ) ;
        $("#unite").val("1034") ;
        }
    }
} ) ;

function return_back()
{
window.history.back() ;
}

$( document ).ready( function()
{
    $("#date_current").val( "{{ now|date_now }}" ) ;
} ) ;
</script>
{% endblock %}
